<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>RideGo</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg-primary: #0D0F14;
    --bg-surface: #1A1D26;
    --bg-surface-raised: #242834;
    --bg-surface-border: #2E3340;
    --text-primary: #F0F1F4;
    --text-secondary: #8B90A0;
    --text-muted: #7A8099;
    --accent: #00D26A;
    --accent-hover: #00B85C;
    --accent-soft: rgba(0,210,106,0.12);
    --warning: #FFB830;
    --danger: #FF4757;
    --blue: #3B82F6;
    --radius-card: 12px;
    --radius-sheet: 20px;
    --radius-button: 24px;
  }

  html, body {
    height: 100%;
    background: #000;
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
    color: var(--text-primary);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    overflow: hidden;
  }

  body {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Phone Frame */
  .phone-frame {
    width: 390px;
    height: 844px;
    background: var(--bg-primary);
    position: relative;
    overflow: hidden;
    border-radius: 44px;
    box-shadow: 0 0 0 4px #1A1D26, 0 0 0 6px #000, 0 24px 80px rgba(0,0,0,0.6);
  }

  @media (max-width: 430px) {
    .phone-frame {
      width: 100vw;
      height: 100vh;
      height: 100dvh;
      border-radius: 0;
      box-shadow: none;
    }
  }

  /* Status Bar */
  .status-bar {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 54px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 28px 0;
    z-index: 100;
    font-size: 15px;
    font-weight: 600;
    color: var(--text-primary);
  }
  .status-bar-time { letter-spacing: 0.5px; }
  .status-bar-icons { display: flex; align-items: center; gap: 6px; }
  .status-bar-icons svg { width: 18px; height: 18px; fill: var(--text-primary); }

  /* Screens */
  .screen {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.35s ease, transform 0.35s ease;
    transform: translateX(30px);
    will-change: transform, opacity;
  }
  .screen.active {
    opacity: 1;
    pointer-events: auto;
    transform: translateX(0);
    z-index: 10;
  }
  .screen.slide-out-left {
    transform: translateX(-30px);
    opacity: 0;
  }
  .screen.slide-in-right {
    transform: translateX(30px);
  }

  /* Back Navigation Animations */
  @keyframes slideInFromLeft {
    from { transform: translateX(-30px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  @keyframes slideOutToRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(30px); opacity: 0; }
  }
  .screen.anim-back-in {
    animation: slideInFromLeft 0.35s ease forwards;
  }
  .screen.anim-back-out {
    animation: slideOutToRight 0.35s ease forwards;
  }

  /* Map Background */
  .map-bg {
    position: absolute;
    inset: 0;
    background: var(--bg-primary);
    background-image:
      linear-gradient(rgba(42,48,66,0.3) 1px, transparent 1px),
      linear-gradient(90deg, rgba(42,48,66,0.3) 1px, transparent 1px);
    background-size: 40px 40px;
  }

  .map-road {
    position: absolute;
    background: rgba(42,48,66,0.5);
    border-radius: 2px;
  }
  .road-h1 { top: 30%; left: 0; right: 0; height: 3px; }
  .road-h2 { top: 55%; left: 0; right: 0; height: 3px; }
  .road-v1 { left: 25%; top: 0; bottom: 0; width: 3px; }
  .road-v2 { left: 60%; top: 0; bottom: 0; width: 3px; }
  .road-v3 { left: 80%; top: 0; bottom: 0; width: 3px; }
  .road-h3 { top: 75%; left: 0; right: 40%; height: 3px; }

  /* Google Maps container */
  .gmap { position: absolute; inset: 0; z-index: 10; }

  /* Location Dot */
  .location-dot {
    position: absolute;
    z-index: 5;
  }
  .location-dot .dot {
    width: 16px;
    height: 16px;
    background: var(--blue);
    border-radius: 50%;
    border: 3px solid #fff;
    box-shadow: 0 0 8px rgba(59,130,246,0.5);
    position: relative;
    z-index: 2;
  }
  .location-dot .ring {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 40px;
    height: 40px;
    background: rgba(59,130,246,0.15);
    border-radius: 50%;
    animation: pulse-ring 2s ease-out infinite;
  }
  @keyframes pulse-ring {
    0% { transform: translate(-50%,-50%) scale(0.8); opacity: 1; }
    100% { transform: translate(-50%,-50%) scale(1.6); opacity: 0; }
  }

  /* Route Markers */
  .route-marker {
    position: absolute;
    z-index: 5;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .route-marker .marker-dot {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 3px solid #fff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }
  .route-marker .marker-label {
    margin-top: 4px;
    font-size: 10px;
    font-weight: 600;
    background: var(--bg-surface);
    padding: 2px 8px;
    border-radius: 6px;
    white-space: nowrap;
    color: var(--text-secondary);
  }
  .marker-green .marker-dot { background: var(--accent); }
  .marker-red .marker-dot { background: var(--danger); }

  /* Animated Route Line */
  .route-line {
    position: absolute;
    z-index: 3;
  }
  .route-line svg { width: 100%; height: 100%; }
  .route-line .route-path {
    stroke: var(--blue);
    stroke-width: 3;
    stroke-dasharray: 8 6;
    fill: none;
    animation: dash-move 1s linear infinite;
  }
  @keyframes dash-move {
    to { stroke-dashoffset: -28; }
  }

  /* Bottom Sheet */
  .bottom-sheet {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--bg-surface);
    border-radius: var(--radius-sheet) var(--radius-sheet) 0 0;
    padding: 12px 20px 20px;
    z-index: 20;
    transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1);
  }
  .sheet-handle {
    width: 40px;
    height: 4px;
    background: var(--bg-surface-border);
    border-radius: 4px;
    margin: 0 auto 16px;
  }

  /* Bottom Nav */
  .bottom-nav {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 80px;
    background: var(--bg-surface);
    border-top: 1px solid var(--bg-surface-border);
    display: flex;
    align-items: center;
    justify-content: space-around;
    padding-bottom: 14px;
    z-index: 30;
  }
  .nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    padding: 6px 12px;
    min-width: 56px;
  }
  .nav-item svg { width: 24px; height: 24px; }
  .nav-item .nav-label { font-size: 11px; font-weight: 500; color: var(--text-muted); }
  .nav-item.active svg { color: var(--accent); fill: var(--accent); }
  .nav-item.active .nav-label { color: var(--accent); }

  /* Buttons */
  .btn-primary {
    width: 100%;
    padding: 16px;
    background: var(--accent);
    color: #003C1E;
    font-size: 16px;
    font-weight: 700;
    border: none;
    border-radius: var(--radius-button);
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
    -webkit-tap-highlight-color: transparent;
    min-height: 52px;
  }
  .btn-primary:hover { background: var(--accent-hover); }
  .btn-primary:active { transform: scale(0.98); }

  .btn-outline {
    padding: 12px 20px;
    background: transparent;
    border: 1.5px solid var(--bg-surface-border);
    border-radius: var(--radius-button);
    color: var(--text-primary);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s, border-color 0.2s;
    -webkit-tap-highlight-color: transparent;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  .btn-outline:hover { background: var(--bg-surface-raised); border-color: var(--text-muted); }
  .btn-outline:active { transform: scale(0.98); }

  .btn-danger-outline {
    padding: 14px;
    background: transparent;
    border: 1.5px solid var(--danger);
    border-radius: var(--radius-button);
    color: var(--danger);
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
    transition: background 0.2s;
    -webkit-tap-highlight-color: transparent;
    min-height: 48px;
  }
  .btn-danger-outline:hover { background: rgba(255,71,87,0.08); }

  .btn-text-danger {
    background: none;
    border: none;
    color: var(--danger);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    padding: 10px;
    -webkit-tap-highlight-color: transparent;
    transition: opacity 0.2s;
  }
  .btn-text-danger:hover { opacity: 0.8; }

  /* Search Bar */
  .search-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--bg-surface-raised);
    border-radius: var(--radius-card);
    padding: 14px 16px;
    cursor: pointer;
    transition: background 0.2s;
    min-height: 52px;
  }
  .search-bar:hover { background: var(--bg-surface-border); }
  .search-bar svg { width: 20px; height: 20px; color: var(--text-muted); flex-shrink: 0; }
  .search-bar span { color: var(--text-muted); font-size: 16px; }

  /* Quick Chips */
  .chips-row {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    scrollbar-width: none;
    padding: 4px 0;
  }
  .chips-row::-webkit-scrollbar { display: none; }
  .chip {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: var(--bg-surface-raised);
    border-radius: 24px;
    white-space: nowrap;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
    cursor: pointer;
    transition: background 0.2s;
    -webkit-tap-highlight-color: transparent;
    min-height: 44px;
  }
  .chip:hover { background: var(--bg-surface-border); }
  .chip-emoji { font-size: 16px; }

  /* Place List */
  .place-list { list-style: none; }
  .place-item {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px 4px;
    cursor: pointer;
    border-radius: 10px;
    transition: background 0.15s;
    -webkit-tap-highlight-color: transparent;
    min-height: 54px;
  }
  .place-item:hover { background: var(--bg-surface-raised); }
  .place-item:active { background: var(--bg-surface-border); }
  .place-icon {
    width: 40px;
    height: 40px;
    background: var(--bg-surface-raised);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  .place-icon svg { width: 18px; height: 18px; color: var(--text-secondary); }
  .place-info { flex: 1; min-width: 0; }
  .place-name { font-size: 15px; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .place-address { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }

  /* Ride Option Card */
  .ride-options { display: flex; flex-direction: column; gap: 8px; }
  .ride-option {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px 16px;
    background: var(--bg-surface-raised);
    border-radius: var(--radius-card);
    cursor: pointer;
    transition: background 0.2s, border-color 0.2s;
    border: 2px solid transparent;
    -webkit-tap-highlight-color: transparent;
    min-height: 68px;
    border-left: 4px solid transparent;
  }
  .ride-option.selected {
    background: var(--accent-soft);
    border-left-color: var(--accent);
  }
  .ride-option:hover:not(.selected) { background: var(--bg-surface-border); }
  .ride-icon { font-size: 28px; flex-shrink: 0; width: 40px; text-align: center; }
  .ride-info { flex: 1; }
  .ride-name { font-size: 15px; font-weight: 700; color: var(--text-primary); }
  .ride-desc { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
  .ride-meta { text-align: right; flex-shrink: 0; }
  .ride-eta { font-size: 12px; color: var(--text-secondary); }
  .ride-price { font-size: 16px; font-weight: 700; color: var(--text-primary); margin-top: 2px; }

  /* Payment Row */
  .payment-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 0;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    min-height: 48px;
  }
  .payment-row svg { width: 20px; height: 20px; color: var(--text-secondary); }
  .payment-row span { flex: 1; font-size: 14px; color: var(--text-primary); }
  .payment-chevron { color: var(--text-muted) !important; }

  /* Driver Card */
  .driver-card {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 16px;
    background: var(--bg-surface-raised);
    border-radius: var(--radius-card);
  }
  .driver-avatar {
    width: 52px;
    height: 52px;
    background: var(--accent-soft);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    font-weight: 700;
    color: var(--accent);
    flex-shrink: 0;
  }
  .driver-info { flex: 1; }
  .driver-name { font-size: 16px; font-weight: 700; }
  .driver-rating { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }
  .driver-car { font-size: 13px; color: var(--text-muted); margin-top: 2px; }

  /* Action Buttons Row */
  .action-row {
    display: flex;
    gap: 12px;
    margin: 16px 0;
  }
  .action-row .btn-outline { flex: 1; }

  /* Trip Timeline */
  .trip-timeline {
    display: flex;
    flex-direction: column;
    gap: 0;
    padding: 12px 0;
  }
  .timeline-point {
    display: flex;
    align-items: flex-start;
    gap: 14px;
  }
  .timeline-connector {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 14px;
    flex-shrink: 0;
    padding-top: 2px;
  }
  .tl-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .tl-dot-green { background: var(--accent); }
  .tl-dot-red { background: var(--danger); }
  .tl-line {
    width: 2px;
    height: 28px;
    background: var(--bg-surface-border);
    margin: 4px 0;
    flex-shrink: 0;
  }
  .tl-dashed {
    border-left: 2px dashed var(--bg-surface-border);
    height: 28px;
    margin: 4px 0;
  }
  .timeline-text .tl-label { font-size: 12px; color: var(--text-muted); }
  .timeline-text .tl-value { font-size: 14px; font-weight: 500; color: var(--text-primary); margin-top: 1px; }

  /* Divider */
  .divider {
    height: 1px;
    background: var(--bg-surface-border);
    margin: 12px 0;
  }

  /* Screen 2 â€” Search */
  .search-screen {
    background: var(--bg-surface);
    padding-top: 54px;
  }
  .search-header {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 16px 20px;
  }
  .back-btn {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-surface-raised);
    border: none;
    border-radius: 10px;
    cursor: pointer;
    flex-shrink: 0;
    -webkit-tap-highlight-color: transparent;
    transition: background 0.2s;
  }
  .back-btn:hover { background: var(--bg-surface-border); }
  .back-btn svg { width: 20px; height: 20px; color: var(--text-primary); }

  .search-inputs {
    flex: 1;
    display: flex;
    gap: 0;
    position: relative;
  }
  .search-timeline {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 14px 0;
    width: 20px;
    flex-shrink: 0;
  }
  .search-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .search-dot-green { background: var(--accent); }
  .search-dot-red { background: var(--danger); }
  .search-dash {
    width: 2px;
    flex: 1;
    border-left: 2px dashed var(--bg-surface-border);
    margin: 4px 0;
  }
  .search-fields {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .search-field {
    background: var(--bg-surface-raised);
    border-radius: 10px;
    padding: 14px 14px;
    font-size: 15px;
    color: var(--text-primary);
    border: none;
    outline: none;
    font-family: inherit;
    width: 100%;
    transition: background 0.2s;
    min-height: 48px;
  }
  .search-field::placeholder { color: var(--text-muted); }
  .search-field:focus { background: var(--bg-surface-border); }
  .search-field-static {
    background: var(--bg-surface-raised);
    border-radius: 10px;
    padding: 14px 14px;
    font-size: 15px;
    color: var(--accent);
    font-weight: 500;
    min-height: 48px;
    display: flex;
    align-items: center;
  }

  .search-results {
    flex: 1;
    overflow-y: auto;
    padding: 0 20px 20px;
  }
  .search-section-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin: 16px 0 8px;
  }

  /* Screen 4 â€” Matching */
  .matching-content {
    text-align: center;
    padding: 20px;
  }
  .matching-content h3 {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 24px;
  }
  .matching-spinner {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 3px solid var(--bg-surface-border);
    border-top-color: var(--accent);
    animation: spin 1s linear infinite;
    margin: 0 auto 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }
  .matching-spinner::after {
    content: 'ðŸš—';
    font-size: 28px;
    position: absolute;
    animation: spin-reverse 1s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes spin-reverse { to { transform: rotate(-360deg); } }
  .matching-sub {
    font-size: 14px;
    color: var(--text-secondary);
    margin: 20px 0 28px;
  }

  /* Screen 5 â€” Arriving Card */
  .arriving-card {
    position: absolute;
    top: 62px;
    left: 20px;
    right: 20px;
    background: var(--bg-surface);
    border-radius: var(--radius-card);
    padding: 14px 18px;
    z-index: 15;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }
  .arriving-dot {
    width: 10px;
    height: 10px;
    background: var(--accent);
    border-radius: 50%;
    animation: pulse-dot 1.5s ease-in-out infinite;
    flex-shrink: 0;
  }
  @keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }
  .arriving-text {
    font-size: 16px;
    font-weight: 700;
    color: var(--accent);
  }
  .arriving-countdown {
    margin-left: auto;
    font-size: 14px;
    color: var(--text-secondary);
    font-weight: 600;
    font-variant-numeric: tabular-nums;
  }

  /* Screen 5 - complete trip button */
  .demo-complete-btn {
    background: var(--accent-soft);
    border: 1.5px solid var(--accent);
    color: var(--accent);
    border-radius: var(--radius-button);
    padding: 10px 18px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    width: 100%;
    margin-top: 8px;
    font-family: inherit;
    transition: background 0.2s;
  }
  .demo-complete-btn:hover { background: rgba(0,210,106,0.2); }

  .share-trip-btn {
    background: none;
    border: none;
    color: var(--blue);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    padding: 8px 0;
    -webkit-tap-highlight-color: transparent;
    text-align: center;
    width: 100%;
    font-family: inherit;
  }

  /* Screen 6 â€” Trip Complete */
  .trip-complete-screen {
    background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-surface) 100%);
    padding: 54px 20px 20px;
    overflow-y: auto;
  }
  .complete-header {
    text-align: center;
    padding: 30px 0 24px;
  }
  .complete-check {
    width: 64px;
    height: 64px;
    background: var(--accent-soft);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 16px;
  }
  .complete-check svg { width: 32px; height: 32px; color: var(--accent); }
  .complete-header h2 { font-size: 22px; font-weight: 700; }

  .fare-card {
    background: var(--bg-surface-raised);
    border-radius: var(--radius-card);
    padding: 20px;
    margin-bottom: 20px;
  }
  .fare-route {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 14px;
  }
  .fare-row {
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
    font-size: 14px;
    color: var(--text-secondary);
  }
  .fare-total {
    font-size: 20px;
    font-weight: 700;
    color: var(--accent);
  }
  .fare-total-label {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
  }

  .rating-section {
    text-align: center;
    margin-bottom: 20px;
  }
  .rating-section h4 { font-size: 16px; font-weight: 600; margin-bottom: 12px; }
  .stars {
    display: flex;
    justify-content: center;
    gap: 8px;
  }
  .star-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    -webkit-tap-highlight-color: transparent;
    transition: transform 0.15s;
    font-size: 0;
  }
  .star-btn:active { transform: scale(1.2); }
  .star-btn svg { width: 36px; height: 36px; }
  .star-btn .star-empty { color: var(--text-muted); }
  .star-btn .star-filled { color: var(--warning); display: none; }
  .star-btn.active .star-empty { display: none; }
  .star-btn.active .star-filled { display: block; }

  .tip-section {
    margin-bottom: 16px;
  }
  .tip-section h4 { font-size: 14px; font-weight: 600; margin-bottom: 10px; color: var(--text-secondary); }
  .tip-row {
    display: flex;
    gap: 8px;
  }
  .tip-btn {
    flex: 1;
    padding: 10px 4px;
    background: var(--bg-surface-raised);
    border: 2px solid transparent;
    border-radius: 10px;
    color: var(--text-primary);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    transition: background 0.2s, border-color 0.2s;
    text-align: center;
    min-height: 44px;
    font-family: inherit;
  }
  .tip-btn:hover { background: var(--bg-surface-border); }
  .tip-btn.active { border-color: var(--accent); background: var(--accent-soft); }

  .comment-box {
    width: 100%;
    background: var(--bg-surface-raised);
    border: none;
    border-radius: var(--radius-card);
    padding: 14px;
    font-size: 14px;
    color: var(--text-primary);
    resize: none;
    font-family: inherit;
    outline: none;
    margin-bottom: 16px;
    min-height: 60px;
    transition: background 0.2s;
  }
  .comment-box::placeholder { color: var(--text-muted); }
  .comment-box:focus { background: var(--bg-surface-border); }

  /* Seat Selector */
  .seat-selector {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px 0;
    margin-bottom: 8px;
  }
  .seat-selector-label {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .seat-selector-label svg {
    width: 18px;
    height: 18px;
    color: var(--text-secondary);
  }
  .seat-controls {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-left: auto;
  }
  .seat-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--bg-surface-raised);
    border: 1.5px solid var(--bg-surface-border);
    color: var(--text-primary);
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    -webkit-tap-highlight-color: transparent;
    transition: background 0.2s, border-color 0.2s;
    font-family: inherit;
  }
  .seat-btn:hover:not(:disabled) { background: var(--bg-surface-border); border-color: var(--text-muted); }
  .seat-btn:disabled { opacity: 0.3; cursor: not-allowed; }
  .seat-count {
    font-size: 18px;
    font-weight: 700;
    color: var(--accent);
    min-width: 24px;
    text-align: center;
    font-variant-numeric: tabular-nums;
  }
  .seat-badge {
    font-size: 11px;
    color: var(--text-muted);
    font-weight: 500;
  }

  /* Promo Link */
  .promo-link {
    text-align: center;
    padding: 6px 0;
  }
  .promo-link a {
    font-size: 13px;
    color: var(--blue);
    text-decoration: none;
    cursor: pointer;
    font-weight: 500;
  }

  /* Scrollable sheet content */
  .sheet-scroll {
    overflow-y: auto;
    max-height: 100%;
    -webkit-overflow-scrolling: touch;
  }

  /* Auth Screen */
  .auth-screen {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: var(--bg-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    padding: 20px;
    overflow-y: auto;
  }
  .auth-screen.hidden { display: none; }
  .auth-card {
    width: 100%;
    max-width: 360px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
  }
  .auth-logo { font-size: 56px; margin-bottom: 4px; }
  .auth-title {
    font-size: 26px;
    font-weight: 800;
    color: var(--text-primary);
    letter-spacing: -0.5px;
  }
  .auth-subtitle {
    font-size: 14px;
    color: var(--text-secondary);
    text-align: center;
    max-width: 280px;
    line-height: 1.5;
  }
  .auth-tabs {
    display: flex;
    width: 100%;
    background: var(--bg-surface);
    border-radius: 12px;
    padding: 4px;
    margin-top: 4px;
  }
  .auth-tab {
    flex: 1;
    text-align: center;
    padding: 10px;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-secondary);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
    background: none;
    font-family: inherit;
  }
  .auth-tab.active {
    background: var(--accent);
    color: #fff;
  }
  .auth-form {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .auth-form.hidden { display: none; }
  .auth-input-group { position: relative; width: 100%; }
  .auth-input-group label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .auth-input {
    width: 100%;
    background: var(--bg-surface-raised);
    border: 1.5px solid var(--bg-surface-border);
    border-radius: 12px;
    padding: 14px 16px;
    font-size: 16px;
    color: var(--text-primary);
    font-family: inherit;
    outline: none;
    transition: border-color 0.2s;
  }
  .auth-input:focus { border-color: var(--accent); }
  .auth-input.error { border-color: var(--danger); }
  .auth-input::placeholder { color: var(--text-muted, #666); }
  .auth-error {
    color: var(--danger);
    font-size: 13px;
    font-weight: 500;
    min-height: 18px;
    text-align: center;
  }
  .auth-success {
    color: var(--success, #22c55e);
    font-size: 13px;
    font-weight: 500;
    min-height: 18px;
    text-align: center;
  }
  .auth-submit {
    width: 100%;
    padding: 15px;
    border: none;
    border-radius: 12px;
    background: var(--accent);
    color: #fff;
    font-size: 16px;
    font-weight: 700;
    font-family: inherit;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  .auth-submit:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .auth-submit:hover:not(:disabled) { opacity: 0.9; }
  .auth-divider {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
    color: var(--text-muted, #666);
    font-size: 12px;
  }
  .auth-divider::before,
  .auth-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--bg-surface-border);
  }
  .auth-footer {
    font-size: 12px;
    color: var(--text-muted, #666);
    text-align: center;
    line-height: 1.5;
    margin-top: 8px;
  }

  /* Account Screen */
  .account-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 40px 20px 24px;
    gap: 8px;
  }
  .account-avatar {
    width: 72px;
    height: 72px;
    border-radius: 50%;
    background: var(--accent);
    color: #fff;
    font-size: 28px;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 4px;
  }
  .account-name {
    font-size: 22px;
    font-weight: 700;
    color: var(--text-primary);
  }
  .account-email {
    font-size: 14px;
    color: var(--text-secondary);
  }
  .account-section {
    padding: 0 20px;
    margin-bottom: 16px;
  }
  .account-menu {
    background: var(--bg-surface);
    border-radius: 16px;
    overflow: hidden;
  }
  .account-menu-item {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 16px 18px;
    font-size: 15px;
    font-weight: 500;
    color: var(--text-primary);
    cursor: pointer;
    transition: background 0.15s;
  }
  .account-menu-item:not(:last-child) {
    border-bottom: 1px solid var(--bg-surface-border);
  }
  .account-menu-item:active {
    background: var(--bg-surface-raised);
  }
  .account-menu-item svg {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
    color: var(--text-secondary);
  }
  .account-menu-item span {
    flex: 1;
  }
  .account-menu-item .chevron {
    width: 16px;
    height: 16px;
    color: var(--text-muted);
  }
  .btn-signout {
    width: 100%;
    padding: 15px;
    border: none;
    border-radius: 14px;
    background: var(--bg-surface);
    color: var(--danger);
    font-size: 16px;
    font-weight: 600;
    font-family: inherit;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: background 0.15s;
  }
  .btn-signout:active {
    background: var(--bg-surface-raised);
  }
  .btn-signout svg {
    width: 20px;
    height: 20px;
    color: var(--danger);
  }
  .account-version {
    text-align: center;
    font-size: 12px;
    color: var(--text-muted);
    padding: 20px;
  }

  /* Sub-pages (Account stack) */
  .subpage {
    background: var(--bg-surface);
    padding-top: 54px;
    overflow-y: auto;
  }
  .page-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 20px;
    position: sticky;
    top: 0;
    background: var(--bg-surface);
    z-index: 5;
    border-bottom: 1px solid var(--bg-surface-border);
  }
  .page-header h1 {
    font-size: 20px;
    font-weight: 700;
    flex: 1;
  }
  .page-content {
    padding: 20px;
    padding-bottom: 100px;
  }

  /* Activity screen */
  .activity-list { list-style: none; }
  .activity-item {
    background: var(--bg-surface-raised);
    border-radius: var(--radius-card);
    padding: 16px;
    margin-bottom: 12px;
    cursor: default;
  }
  .activity-route {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-primary);
  }
  .activity-meta {
    font-size: 13px;
    color: var(--text-secondary);
    margin-top: 6px;
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 4px;
  }
  .activity-status {
    font-size: 12px;
    font-weight: 600;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid var(--bg-surface-border);
  }
  .activity-status.completed { color: var(--accent); }
  .activity-status.cancelled { color: var(--text-muted); }
  .activity-empty {
    text-align: center;
    padding: 48px 24px;
    color: var(--text-muted);
    font-size: 15px;
  }
  .activity-empty svg {
    width: 48px;
    height: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  /* Help screen */
  .help-list { list-style: none; }
  .help-item {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 16px 0;
    border-bottom: 1px solid var(--bg-surface-border);
    cursor: pointer;
    transition: background 0.15s;
  }
  .help-item:active { background: var(--bg-surface-raised); }
  .help-item svg { width: 22px; height: 22px; color: var(--text-secondary); flex-shrink: 0; }
  .help-item span { font-size: 15px; font-weight: 500; color: var(--text-primary); }
  .help-section-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin: 24px 0 8px;
  }
  .help-section-title:first-child { margin-top: 0; }

  /* Investors page */
  .investors-total-card {
    background: var(--accent-soft);
    border: 1px solid rgba(0,210,106,0.25);
    border-radius: var(--radius-card);
    padding: 20px;
    margin-bottom: 24px;
    text-align: center;
  }
  .investors-total-label {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
  }
  .investors-total-amount {
    font-size: 28px;
    font-weight: 700;
    color: var(--accent);
  }
  .investors-total-meta {
    font-size: 13px;
    color: var(--text-muted);
    margin-top: 8px;
  }
  .form-checkbox-label {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
  }
  .form-checkbox-label input { width: auto; margin: 0; }
  .investors-list { list-style: none; }
  .investors-item {
    background: var(--bg-surface-raised);
    border-radius: var(--radius-card);
    padding: 14px 16px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
  }
  .investors-item-name { font-weight: 600; color: var(--text-primary); }
  .investors-item-amount { font-weight: 600; color: var(--accent); }
  .investors-item-contact { font-size: 12px; color: var(--text-muted); width: 100%; margin-top: 4px; }
  .investors-empty {
    text-align: center;
    padding: 24px;
    color: var(--text-muted);
    font-size: 14px;
  }

  /* Edit Profile form */
  .form-group {
    margin-bottom: 20px;
  }
  .form-group label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 8px;
  }
  .form-group input {
    width: 100%;
    padding: 14px 16px;
    background: var(--bg-surface-raised);
    border: 1px solid var(--bg-surface-border);
    border-radius: 10px;
    font-size: 15px;
    color: var(--text-primary);
    font-family: inherit;
  }
  .form-group input:focus {
    outline: none;
    border-color: var(--accent);
  }

  /* Payment methods list */
  .payment-method-item {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 16px;
    background: var(--bg-surface-raised);
    border-radius: var(--radius-card);
    margin-bottom: 12px;
  }
  .payment-method-item.default { border: 1px solid var(--accent); background: var(--accent-soft); }
  .payment-method-item svg { width: 24px; height: 24px; color: var(--text-secondary); flex-shrink: 0; }
  .payment-method-item .pm-label { font-size: 15px; font-weight: 600; color: var(--text-primary); }
  .payment-method-item .pm-default { font-size: 12px; color: var(--accent); margin-top: 2px; }
  .add-payment-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    width: 100%;
    padding: 16px;
    background: var(--bg-surface-raised);
    border: 2px dashed var(--bg-surface-border);
    border-radius: var(--radius-card);
    color: var(--text-muted);
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    margin-top: 12px;
    transition: border-color 0.2s, color 0.2s;
  }
  .add-payment-btn:hover { border-color: var(--text-muted); color: var(--text-secondary); }

  /* Safety / Settings content */
  .content-card {
    background: var(--bg-surface-raised);
    border-radius: var(--radius-card);
    padding: 20px;
    margin-bottom: 16px;
  }
  .content-card h3 { font-size: 16px; font-weight: 700; margin-bottom: 10px; }
  .content-card p { font-size: 14px; color: var(--text-secondary); line-height: 1.5; }

  /* Utility */
  .mt-12 { margin-top: 12px; }
  .mt-16 { margin-top: 16px; }
  .mb-8 { margin-bottom: 8px; }
  .mb-12 { margin-bottom: 12px; }
  .mb-16 { margin-bottom: 16px; }
  .gap-10 { gap: 10px; }

  /* Toast Notifications */
  .toast-container { position: absolute; top: 60px; left: 16px; right: 16px; z-index: 2000; display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
  .toast { padding: 14px 18px; border-radius: 12px; font-size: 14px; font-weight: 500; color: #fff; pointer-events: auto; animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .toast.success { background: #22c55e; }
  .toast.error { background: var(--danger); }
  .toast.info { background: var(--bg-surface-raised); color: var(--text-primary); border: 1px solid var(--bg-surface-border); }
  @keyframes toastIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes toastOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-10px); } }

  /* Skeleton Loading */
  .skeleton { background: var(--bg-surface-raised); border-radius: 12px; position: relative; overflow: hidden; }
  .skeleton::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent); animation: shimmer 1.5s infinite; }
  @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
  .skeleton-ride { height: 80px; margin-bottom: 10px; }
  .skeleton-place { height: 56px; margin-bottom: 8px; }
  .skeleton-activity { height: 72px; margin-bottom: 10px; }
  .skeleton-text { height: 16px; margin-bottom: 8px; width: 60%; }

  /* Button Loading */
  .btn-loading { pointer-events: none; opacity: 0.7; }
  .btn-loading .btn-spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.6s linear infinite; margin-right: 8px; vertical-align: middle; }

  /* Micro-interactions */
  .ride-option, .place-item, .suggestion-item, .chip, .account-menu-item, .activity-item { transition: transform 0.1s ease, background 0.2s ease; }
  .ride-option:active, .place-item:active, .suggestion-item:active, .chip:active, .account-menu-item:active, .activity-item:active { transform: scale(0.97); }
  .bottom-sheet { transition: transform 0.3s ease; }

  /* Settings */
  .settings-section { margin-bottom: 24px; }
  .settings-section-title { font-size: 13px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
  .setting-row { display: flex; align-items: center; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid var(--bg-surface-border); }
  .setting-row:last-child { border-bottom: none; }
  .setting-label { font-size: 15px; color: var(--text-primary); }
  .setting-desc { font-size: 13px; color: var(--text-muted); margin-top: 2px; }
  .toggle-switch { position: relative; width: 48px; height: 28px; flex-shrink: 0; }
  .toggle-switch input { opacity: 0; width: 0; height: 0; }
  .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-surface-raised); border-radius: 28px; transition: 0.3s; }
  .toggle-slider::before { content: ''; position: absolute; height: 22px; width: 22px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; }
  .toggle-switch input:checked + .toggle-slider { background: var(--accent); }
  .toggle-switch input:checked + .toggle-slider::before { transform: translateX(20px); }

  /* Safety */
  .emergency-btn { display: flex; align-items: center; gap: 14px; background: var(--danger); color: white; padding: 16px 20px; border-radius: 16px; margin-bottom: 20px; text-decoration: none; transition: transform 0.1s; }
  .emergency-btn:active { transform: scale(0.98); }
  .safety-card { background: var(--bg-surface-raised); border-radius: 16px; padding: 18px; margin-bottom: 14px; }
  .safety-card-title { font-size: 16px; font-weight: 600; margin-bottom: 12px; }
  .safety-tips-list { padding-left: 20px; margin: 0; }
  .safety-tips-list li { color: var(--text-secondary); font-size: 14px; line-height: 1.6; margin-bottom: 6px; }
  .emergency-contact-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--bg-surface-border); }
  .emergency-contact-item:last-child { border-bottom: none; }

  /* Add Payment */
  .form-label { font-size: 13px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
  .card-brand-selector { display: flex; gap: 8px; margin-top: 8px; }
  .card-brand-btn { flex: 1; padding: 10px; border-radius: 10px; background: var(--bg-surface-raised); color: var(--text-secondary); border: 2px solid transparent; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-family: inherit; }
  .card-brand-btn.selected { border-color: var(--accent); color: var(--accent); background: var(--accent-soft); }

  /* Success animation */
  .complete-check { animation: bounceIn 0.5s ease; }
  @keyframes bounceIn { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.15); } 100% { transform: scale(1); opacity: 1; } }

  /* Empty states */
  .empty-state { text-align: center; padding: 40px 20px; }
  .empty-state-icon { font-size: 48px; margin-bottom: 12px; }
  .empty-state-text { color: var(--text-muted); font-size: 15px; }

  /* Location Permission Modal */
  .location-modal { position: absolute; inset: 0; z-index: 200; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; padding: 30px; backdrop-filter: blur(4px); }
  .location-modal-card { background: var(--bg-surface); border-radius: 20px; padding: 32px 24px 24px; text-align: center; width: 100%; animation: modalPop 0.3s ease; }
  @keyframes modalPop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  .location-modal-icon { font-size: 48px; margin-bottom: 16px; }
  .location-modal-card h3 { font-size: 18px; font-weight: 700; margin-bottom: 10px; }
  .location-modal-card p { font-size: 14px; color: var(--text-secondary); line-height: 1.5; margin-bottom: 24px; }
  .location-status { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-muted); margin-bottom: 12px; }
  .location-status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted); flex-shrink: 0; }
  .location-status-dot.active { background: #22c55e; box-shadow: 0 0 6px rgba(34,197,94,0.5); animation: loc-pulse 2s infinite; }
  @keyframes loc-pulse { 0%, 100% { box-shadow: 0 0 6px rgba(34,197,94,0.5); } 50% { box-shadow: 0 0 12px rgba(34,197,94,0.8); } }

  /* Chat Panel */
  .chat-overlay { position: absolute; inset: 0; z-index: 50; display: flex; flex-direction: column; background: var(--bg-primary); transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.32,0.72,0,1); pointer-events: none; }
  .chat-overlay.open { transform: translateY(0); pointer-events: auto; }
  .chat-header { display: flex; align-items: center; gap: 12px; padding: 54px 20px 14px; background: var(--bg-surface); border-bottom: 1px solid var(--bg-surface-border, rgba(255,255,255,0.06)); flex-shrink: 0; }
  .chat-header h3 { flex: 1; font-size: 17px; font-weight: 700; }
  .chat-close { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: var(--bg-surface-raised, rgba(255,255,255,0.08)); border: none; border-radius: 50%; cursor: pointer; -webkit-tap-highlight-color: transparent; }
  .chat-close svg { width: 18px; height: 18px; color: var(--text-primary); }
  .chat-messages { flex: 1; overflow-y: auto; padding: 16px 20px; display: flex; flex-direction: column; gap: 8px; -webkit-overflow-scrolling: touch; }
  .chat-bubble { max-width: 80%; padding: 10px 14px; border-radius: 16px; font-size: 14px; line-height: 1.4; word-wrap: break-word; }
  .chat-bubble.sent { align-self: flex-end; background: var(--accent); color: #003C1E; border-bottom-right-radius: 4px; }
  .chat-bubble.received { align-self: flex-start; background: var(--bg-surface-raised, rgba(255,255,255,0.08)); color: var(--text-primary); border-bottom-left-radius: 4px; }
  .chat-bubble-time { font-size: 11px; opacity: 0.6; margin-top: 4px; }
  .chat-empty { flex: 1; display: flex; align-items: center; justify-content: center; color: var(--text-muted); font-size: 14px; text-align: center; padding: 20px; }
  .chat-input-row { display: flex; align-items: center; gap: 10px; padding: 12px 20px 28px; background: var(--bg-surface); border-top: 1px solid var(--bg-surface-border, rgba(255,255,255,0.06)); flex-shrink: 0; }
  .chat-input { flex: 1; background: var(--bg-surface-raised, rgba(255,255,255,0.08)); border: none; border-radius: 20px; padding: 12px 16px; font-size: 15px; color: var(--text-primary); font-family: inherit; outline: none; min-height: 44px; resize: none; }
  .chat-input::placeholder { color: var(--text-muted); }
  .chat-send-btn { width: 44px; height: 44px; border-radius: 50%; background: var(--accent); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; -webkit-tap-highlight-color: transparent; transition: opacity 0.2s, transform 0.1s; }
  .chat-send-btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .chat-send-btn:active:not(:disabled) { transform: scale(0.92); }
  .chat-send-btn svg { width: 20px; height: 20px; color: #003C1E; }
  .msg-badge { background: var(--danger, #ef4444); color: #fff; font-size: 11px; font-weight: 700; min-width: 18px; height: 18px; border-radius: 9px; display: inline-flex; align-items: center; justify-content: center; padding: 0 5px; margin-left: 6px; }
  .msg-badge:empty { display: none; }

  /* Active Ride Banner */
  .active-ride-banner { display: none; background: var(--bg-surface); border: 1px solid var(--accent); border-radius: 16px; padding: 14px 16px; margin-bottom: 16px; animation: modalPop 0.3s ease; }
  .active-ride-banner.visible { display: block; }
  .arb-header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
  .arb-pulse { width: 10px; height: 10px; border-radius: 50%; background: var(--accent); animation: loc-pulse 2s infinite; flex-shrink: 0; }
  .arb-title { font-size: 14px; font-weight: 700; color: var(--accent); }
  .arb-route { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
  .arb-status { font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; }
  .arb-actions { display: flex; gap: 10px; }
  .arb-actions .btn-primary { flex: 1; padding: 10px; font-size: 14px; }
  .arb-actions .btn-outline { flex: 1; padding: 10px; font-size: 14px; text-align: center; }
</style>
</head>
<body>
<!-- Auth Screen -->
<div class="auth-screen" id="auth-screen">
  <div class="auth-card">
    <div class="auth-logo">ðŸš•</div>
    <div class="auth-title">RideGo</div>
    <div class="auth-subtitle">Sign in to request rides around Oslo</div>

    <div class="auth-tabs">
      <button class="auth-tab active" id="tab-signin" onclick="switchAuthTab('signin')">Sign In</button>
      <button class="auth-tab" id="tab-signup" onclick="switchAuthTab('signup')">Sign Up</button>
    </div>

    <!-- Sign In Form -->
    <form class="auth-form" id="form-signin" onsubmit="handleSignIn(event)">
      <div class="auth-input-group">
        <label>Email</label>
        <input class="auth-input" type="email" id="signin-email" placeholder="you@example.com" required autocomplete="email">
      </div>
      <div class="auth-input-group">
        <label>Password</label>
        <input class="auth-input" type="password" id="signin-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required autocomplete="current-password">
      </div>
      <div class="auth-error" id="signin-error"></div>
      <button class="auth-submit" type="submit" id="signin-btn">Sign In</button>
    </form>

    <!-- Sign Up Form -->
    <form class="auth-form hidden" id="form-signup" onsubmit="handleSignUp(event)">
      <div class="auth-input-group">
        <label>Name</label>
        <input class="auth-input" type="text" id="signup-name" placeholder="Your name" required autocomplete="name">
      </div>
      <div class="auth-input-group">
        <label>Email</label>
        <input class="auth-input" type="email" id="signup-email" placeholder="you@example.com" required autocomplete="email">
      </div>
      <div class="auth-input-group">
        <label>Password</label>
        <input class="auth-input" type="password" id="signup-password" placeholder="Min 6 characters" required minlength="6" autocomplete="new-password">
      </div>
      <div class="auth-error" id="signup-error"></div>
      <div class="auth-success" id="signup-success"></div>
      <button class="auth-submit" type="submit" id="signup-btn">Create Account</button>
    </form>

    <div class="auth-footer">
      Private preview â€” by invitation only
    </div>
  </div>
</div>

<div class="phone-frame" id="app" style="display:none;">

  <div class="toast-container" id="toast-container"></div>

  <!-- Status Bar -->
  <div class="status-bar" id="status-bar">
    <span class="status-bar-time" id="status-time">9:41</span>
    <div class="status-bar-icons">
      <svg viewBox="0 0 24 24"><path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3a4.237 4.237 0 00-6 0zm-4-4l2 2a7.074 7.074 0 0110 0l2-2C15.14 9.14 8.87 9.14 5 13z"/></svg>
      <svg viewBox="0 0 24 24"><path d="M15.67 4H14V2h-4v2H8.33C7.6 4 7 4.6 7 5.33v15.33C7 21.4 7.6 22 8.33 22h7.33c.74 0 1.34-.6 1.34-1.33V5.33C17 4.6 16.4 4 15.67 4z"/></svg>
    </div>
  </div>

  <!-- ==================== SCREEN 1: HOME ==================== -->
  <div class="screen active" id="screen-home">
    <div class="map-bg">
      <div class="gmap" id="gmap-home"></div>
      <div class="map-road road-h1"></div>
      <div class="map-road road-h2"></div>
      <div class="map-road road-v1"></div>
      <div class="map-road road-v2"></div>
      <div class="map-road road-v3"></div>
      <div class="map-road road-h3"></div>
      <div class="location-dot" style="top:38%;left:50%;transform:translate(-50%,-50%)">
        <div class="ring"></div>
        <div class="dot"></div>
      </div>
    </div>
    <div class="bottom-sheet" style="height:48%;padding-bottom:80px;">
      <div class="sheet-handle"></div>
      <h2 style="font-size:20px;font-weight:700;margin-bottom:16px;" id="greeting">Good evening, Alex ðŸ‘‹</h2>
      <div class="location-status" id="location-status">
        <div class="location-status-dot" id="location-dot"></div>
        <span id="location-status-text">Location unavailable</span>
      </div>
      <!-- Active Ride Banner -->
      <div class="active-ride-banner" id="active-ride-banner">
        <div class="arb-header">
          <div class="arb-pulse"></div>
          <span class="arb-title">Ride in progress</span>
        </div>
        <div class="arb-route" id="arb-route">Nydalen â†’ Aker Brygge</div>
        <div class="arb-status" id="arb-status">Driver is arriving</div>
        <div class="arb-actions">
          <button class="btn-primary" id="arb-resume">Resume</button>
          <button class="btn-outline" id="arb-cancel">Cancel Ride</button>
        </div>
      </div>

      <div class="search-bar mb-16" id="home-search">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <span>Where to?</span>
      </div>
      <div class="chips-row mb-16">
        <div class="chip"><span class="chip-emoji">ðŸ </span> Home</div>
        <div class="chip"><span class="chip-emoji">ðŸ’¼</span> Work</div>
        <div class="chip"><span class="chip-emoji">âœˆï¸</span> Airport</div>
      </div>
      <div>
        <ul class="place-list">
          <li class="place-item" data-name="Aker Brygge" data-lat="59.9075" data-lng="10.7295" data-address="Brynjulf Bulls plass 6, Oslo">
            <div class="place-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
            <div class="place-info">
              <div class="place-name">Aker Brygge</div>
              <div class="place-address">Brynjulf Bulls plass 6, Oslo</div>
            </div>
          </li>
          <li class="place-item" data-name="Oslo Sentralstasjon" data-lat="59.9111" data-lng="10.7528" data-address="Jernbanetorget 1, Oslo">
            <div class="place-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
            <div class="place-info">
              <div class="place-name">Oslo Sentralstasjon</div>
              <div class="place-address">Jernbanetorget 1, Oslo</div>
            </div>
          </li>
          <li class="place-item" data-name="GrÃ¼nerlÃ¸kka" data-lat="59.9225" data-lng="10.7590" data-address="Thorvald Meyers gate, Oslo">
            <div class="place-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
            <div class="place-info">
              <div class="place-name">GrÃ¼nerlÃ¸kka</div>
              <div class="place-address">Thorvald Meyers gate, Oslo</div>
            </div>
          </li>
        </ul>
      </div>
    </div>
    <div class="bottom-nav">
      <div class="nav-item active" data-nav="home">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        <span class="nav-label">Home</span>
      </div>
      <div class="nav-item" data-nav="activity">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        <span class="nav-label">Activity</span>
      </div>
      <div class="nav-item" data-nav="account">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        <span class="nav-label">Account</span>
      </div>
      <div class="nav-item" data-nav="help">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        <span class="nav-label">Help</span>
      </div>
    </div>
  </div>

  <!-- ==================== SCREEN 2: SEARCH ==================== -->
  <div class="screen search-screen" id="screen-search">
    <div class="search-header">
      <button class="back-btn" id="search-back">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
      </button>
      <div class="search-inputs">
        <div class="search-timeline">
          <div class="search-dot search-dot-green"></div>
          <div class="search-dash"></div>
          <div class="search-dot search-dot-red"></div>
        </div>
        <div class="search-fields">
          <div class="search-field-static">Current Location</div>
          <input class="search-field" id="dest-input" type="text" placeholder="Enter destination" autofocus>
        </div>
      </div>
    </div>
    <div class="search-results" id="search-results">
      <div class="search-section-title">Recent</div>
      <ul class="place-list" id="recent-list">
        <li class="place-item suggestion-item" data-name="Aker Brygge">
          <div class="place-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
          <div class="place-info">
            <div class="place-name">Aker Brygge</div>
            <div class="place-address">Brynjulf Bulls plass 6, Oslo</div>
          </div>
        </li>
        <li class="place-item suggestion-item" data-name="Oslo Sentralstasjon">
          <div class="place-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
          <div class="place-info">
            <div class="place-name">Oslo Sentralstasjon</div>
            <div class="place-address">Jernbanetorget 1, Oslo</div>
          </div>
        </li>
        <li class="place-item suggestion-item" data-name="GrÃ¼nerlÃ¸kka">
          <div class="place-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
          <div class="place-info">
            <div class="place-name">GrÃ¼nerlÃ¸kka</div>
            <div class="place-address">Thorvald Meyers gate, Oslo</div>
          </div>
        </li>
      </ul>
      <div class="search-section-title">Suggestions</div>
      <ul class="place-list" id="suggestions-list">
        <li class="place-item suggestion-item" data-name="Aker Brygge">
          <div class="place-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg></div>
          <div class="place-info">
            <div class="place-name">Aker Brygge</div>
            <div class="place-address">Brynjulf Bulls plass 6, Oslo</div>
          </div>
        </li>
        <li class="place-item suggestion-item" data-name="Nationaltheatret">
          <div class="place-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg></div>
          <div class="place-info">
            <div class="place-name">Nationaltheatret</div>
            <div class="place-address">Johanne Dybwads plass 1, Oslo</div>
          </div>
        </li>
        <li class="place-item suggestion-item" data-name="Oslo Lufthavn">
          <div class="place-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg></div>
          <div class="place-info">
            <div class="place-name">Oslo Lufthavn</div>
            <div class="place-address">Edvard Munchs veg, Gardermoen</div>
          </div>
        </li>
        <li class="place-item suggestion-item" data-name="Vigeland Sculpture Park">
          <div class="place-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg></div>
          <div class="place-info">
            <div class="place-name">Vigeland Sculpture Park</div>
            <div class="place-address">Nobels gate 32, Oslo</div>
          </div>
        </li>
        <li class="place-item suggestion-item" data-name="Holmenkollen">
          <div class="place-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg></div>
          <div class="place-info">
            <div class="place-name">Holmenkollen</div>
            <div class="place-address">Kongeveien 5, Oslo</div>
          </div>
        </li>
      </ul>
    </div>
  </div>

  <!-- ==================== SCREEN 3: RIDE OPTIONS ==================== -->
  <div class="screen" id="screen-ride-options">
    <div class="map-bg">
      <div class="gmap" id="gmap-ride"></div>
      <div class="map-road road-h1"></div>
      <div class="map-road road-h2"></div>
      <div class="map-road road-v1"></div>
      <div class="map-road road-v2"></div>
      <div class="map-road road-v3"></div>
      <div class="map-road road-h3"></div>

      <!-- Pickup marker -->
      <div class="route-marker marker-green" style="top:26%;left:28%">
        <div class="marker-dot"></div>
        <div class="marker-label">Nydalen</div>
      </div>
      <!-- Destination marker -->
      <div class="route-marker marker-red" style="top:42%;left:68%">
        <div class="marker-dot"></div>
        <div class="marker-label" id="dest-marker-label">Aker Brygge</div>
      </div>
      <!-- Route line -->
      <div class="route-line" style="top:24%;left:26%;width:48%;height:24%;">
        <svg viewBox="0 0 200 100" preserveAspectRatio="none">
          <path class="route-path" d="M10,15 C50,15 50,50 100,50 C150,50 150,80 190,80"/>
        </svg>
      </div>
    </div>

    <div class="bottom-sheet" style="height:60%;">
      <div class="sheet-handle"></div>
      <div class="sheet-scroll">
        <div class="seat-selector" id="seat-selector">
          <div class="seat-selector-label">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
            Seats needed
          </div>
          <div class="seat-controls">
            <button class="seat-btn" id="seat-minus" disabled>âˆ’</button>
            <span class="seat-count" id="seat-count">1</span>
            <button class="seat-btn" id="seat-plus">+</button>
          </div>
        </div>

        <div class="ride-options mb-16" id="ride-options">
          <div class="ride-option selected" data-ride="economy" data-price="89" data-seats="4">
            <div class="ride-icon">ðŸš—</div>
            <div class="ride-info">
              <div class="ride-name">Economy</div>
              <div class="ride-desc"><span class="seat-badge">4 seats</span> Â· Affordable rides</div>
            </div>
            <div class="ride-meta">
              <div class="ride-eta">3 min</div>
              <div class="ride-price">kr 89</div>
            </div>
          </div>
          <div class="ride-option" data-ride="comfort" data-price="139" data-seats="4">
            <div class="ride-icon">ðŸš˜</div>
            <div class="ride-info">
              <div class="ride-name">Comfort</div>
              <div class="ride-desc"><span class="seat-badge">4 seats</span> Â· Top-rated drivers</div>
            </div>
            <div class="ride-meta">
              <div class="ride-eta">5 min</div>
              <div class="ride-price">kr 139</div>
            </div>
          </div>
          <div class="ride-option" data-ride="xl" data-price="199" data-seats="7">
            <div class="ride-icon">ðŸš</div>
            <div class="ride-info">
              <div class="ride-name">XL</div>
              <div class="ride-desc"><span class="seat-badge">7 seats</span> Â· Vans for groups</div>
            </div>
            <div class="ride-meta">
              <div class="ride-eta">8 min</div>
              <div class="ride-price">kr 199</div>
            </div>
          </div>
        </div>

        <div class="payment-row" style="border-top:1px solid var(--bg-surface-border);border-bottom:1px solid var(--bg-surface-border);">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
          <span>Visa â€¢â€¢â€¢â€¢ 4242</span>
          <svg class="payment-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
        </div>

        <div class="promo-link mt-12 mb-12">
          <a>Add promo code</a>
        </div>

        <button class="btn-primary" id="confirm-ride-btn">Confirm Economy â€” kr 89</button>

        <div style="height:20px"></div>
      </div>
    </div>

    <button class="back-btn" id="ride-back" style="position:absolute;top:62px;left:20px;z-index:15;box-shadow:0 2px 10px rgba(0,0,0,0.3);">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
    </button>
  </div>

  <!-- ==================== SCREEN 4: DRIVER MATCHING ==================== -->
  <div class="screen" id="screen-matching">
    <div class="map-bg">
      <div class="gmap" id="gmap-matching"></div>
      <div class="map-road road-h1"></div>
      <div class="map-road road-h2"></div>
      <div class="map-road road-v1"></div>
      <div class="map-road road-v2"></div>
      <div class="map-road road-v3"></div>
      <div class="map-road road-h3"></div>
      <div class="location-dot" style="top:38%;left:50%;transform:translate(-50%,-50%)">
        <div class="ring"></div>
        <div class="dot"></div>
      </div>
    </div>
    <div class="bottom-sheet" style="height:44%;">
      <div class="sheet-handle"></div>
      <div class="matching-content">
        <h3>Finding your ride...</h3>
        <div class="matching-spinner"></div>
        <div class="matching-sub">Searching nearby drivers...</div>
        <button class="btn-danger-outline" id="cancel-matching">Cancel Ride</button>
      </div>
    </div>
  </div>

  <!-- ==================== SCREEN 5: TRIP CONFIRMED ==================== -->
  <div class="screen" id="screen-trip">
    <div class="map-bg">
      <div class="gmap" id="gmap-trip"></div>
      <div class="map-road road-h1"></div>
      <div class="map-road road-h2"></div>
      <div class="map-road road-v1"></div>
      <div class="map-road road-v2"></div>
      <div class="map-road road-v3"></div>
      <div class="map-road road-h3"></div>
      <div class="route-marker marker-green" style="top:26%;left:28%">
        <div class="marker-dot"></div>
        <div class="marker-label">Nydalen</div>
      </div>
      <div class="route-marker marker-red" style="top:42%;left:68%">
        <div class="marker-dot"></div>
        <div class="marker-label" id="trip-dest-marker-label">Aker Brygge</div>
      </div>
      <div class="route-line" style="top:24%;left:26%;width:48%;height:24%;">
        <svg viewBox="0 0 200 100" preserveAspectRatio="none">
          <path class="route-path" d="M10,15 C50,15 50,50 100,50 C150,50 150,80 190,80"/>
        </svg>
      </div>
    </div>

    <div class="arriving-card">
      <div class="arriving-dot"></div>
      <span class="arriving-text" id="arriving-text">Arriving in 3 min</span>
      <span class="arriving-countdown" id="arriving-countdown">3:00</span>
    </div>

    <div class="bottom-sheet" style="height:54%;">
      <div class="sheet-handle"></div>
      <div class="sheet-scroll">
        <div class="driver-card mb-16">
          <div class="driver-avatar">M</div>
          <div class="driver-info">
            <div class="driver-name">Mohamed K.</div>
            <div class="driver-rating">4.9 â­ Â· 847 trips</div>
            <div class="driver-car">White Toyota Camry Â· ABC 123</div>
          </div>
        </div>

        <div class="action-row" id="trip-action-row">
          <button class="btn-outline" id="trip-call-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="18" height="18"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/></svg>
            Call
          </button>
          <button class="btn-outline" id="trip-message-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="18" height="18"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
            Message
            <span class="msg-badge" id="msg-badge"></span>
          </button>
        </div>

        <div class="trip-timeline">
          <div class="timeline-point">
            <div class="timeline-connector">
              <div class="tl-dot tl-dot-green"></div>
              <div class="tl-dashed"></div>
            </div>
            <div class="timeline-text">
              <div class="tl-label">PICKUP</div>
              <div class="tl-value">Nydalen T-banestasjon</div>
            </div>
          </div>
          <div class="timeline-point">
            <div class="timeline-connector">
              <div class="tl-dot tl-dot-red"></div>
            </div>
            <div class="timeline-text">
              <div class="tl-label">DROP-OFF</div>
              <div class="tl-value" id="trip-dropoff">Aker Brygge</div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <button class="btn-text-danger" id="cancel-trip" style="width:100%;text-align:center;">Cancel Ride</button>
        <button class="share-trip-btn">ðŸ“ Share trip status</button>

        <div class="divider"></div>

        <button class="demo-complete-btn" id="complete-trip-btn">â–¶ Complete Trip (Demo)</button>

        <div style="height:20px"></div>
      </div>
    </div>

    <!-- Chat Overlay -->
    <div class="chat-overlay" id="chat-overlay">
      <div class="chat-header">
        <button class="chat-close" id="chat-close-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
        <h3 id="chat-driver-name">Chat with Driver</h3>
      </div>
      <div class="chat-messages" id="chat-messages">
        <div class="chat-empty" id="chat-empty">Send a message to your driver</div>
      </div>
      <div class="chat-input-row">
        <input class="chat-input" id="chat-input" type="text" placeholder="Type a message..." maxlength="1000" autocomplete="off">
        <button class="chat-send-btn" id="chat-send-btn" disabled>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- ==================== SCREEN 6: TRIP COMPLETE ==================== -->
  <div class="screen trip-complete-screen" id="screen-complete">
    <div class="complete-header">
      <div class="complete-check">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
      </div>
      <h2>Trip Complete âœ“</h2>
    </div>

    <div class="fare-card">
      <div class="fare-route" id="fare-route">Nydalen â†’ Aker Brygge</div>
      <div class="fare-row"><span>Base fare</span><span id="fare-base">kr 49</span></div>
      <div class="fare-row"><span>Distance (4.2 km)</span><span id="fare-dist">kr 34</span></div>
      <div class="fare-row"><span>Time (12 min)</span><span id="fare-time">kr 6</span></div>
      <div class="divider"></div>
      <div class="fare-row">
        <span class="fare-total-label">Total</span>
        <span class="fare-total" id="fare-total">kr 89</span>
      </div>
    </div>

    <div class="rating-section">
      <h4>Rate your ride</h4>
      <div class="stars" id="stars">
        <button class="star-btn" data-star="1">
          <svg class="star-empty" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
          <svg class="star-filled" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        </button>
        <button class="star-btn" data-star="2">
          <svg class="star-empty" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
          <svg class="star-filled" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        </button>
        <button class="star-btn" data-star="3">
          <svg class="star-empty" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
          <svg class="star-filled" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        </button>
        <button class="star-btn" data-star="4">
          <svg class="star-empty" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
          <svg class="star-filled" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        </button>
        <button class="star-btn" data-star="5">
          <svg class="star-empty" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
          <svg class="star-filled" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        </button>
      </div>
    </div>

    <div class="tip-section">
      <h4>Add a tip</h4>
      <div class="tip-row" id="tip-row">
        <button class="tip-btn active" data-tip="0">No tip</button>
        <button class="tip-btn" data-tip="10">kr 10</button>
        <button class="tip-btn" data-tip="20">kr 20</button>
        <button class="tip-btn" data-tip="30">kr 30</button>
      </div>
    </div>

    <textarea class="comment-box" placeholder="Additional comments..." rows="2"></textarea>

    <button class="btn-primary" id="done-btn">Done</button>
  </div>

  <!-- ==================== SCREEN 7: ACCOUNT ==================== -->
  <div class="screen" id="screen-account">
    <div class="account-header">
      <div class="account-avatar" id="account-avatar">J</div>
      <h2 class="account-name" id="account-name">â€”</h2>
      <p class="account-email" id="account-email">â€”</p>
    </div>

    <div class="account-section">
      <div class="account-menu">
        <div class="account-menu-item" data-page="edit-profile">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          <span>Edit Profile</span>
          <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
        </div>
        <div class="account-menu-item" data-page="investors">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
          <span>Investors</span>
          <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
        </div>
        <div class="account-menu-item" data-page="payment-methods">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
          <span>Payment Methods</span>
          <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
        </div>
        <div class="account-menu-item" data-page="safety">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          <span>Safety</span>
          <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
        </div>
        <div class="account-menu-item" data-page="settings">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
          <span>Settings</span>
          <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
        </div>
      </div>
    </div>

    <div class="account-section">
      <button class="btn-signout" id="btn-signout">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Sign Out
      </button>
    </div>

    <div class="account-version">RideGo v1.0 â€” Oslo</div>

    <div class="bottom-nav">
      <div class="nav-item" data-nav="home">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        <span class="nav-label">Home</span>
      </div>
      <div class="nav-item" data-nav="activity">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        <span class="nav-label">Activity</span>
      </div>
      <div class="nav-item" data-nav="account">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        <span class="nav-label">Account</span>
      </div>
      <div class="nav-item" data-nav="help">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        <span class="nav-label">Help</span>
      </div>
    </div>
  </div>

  <!-- ==================== SCREEN: ACTIVITY (Ride history) ==================== -->
  <div class="screen subpage" id="screen-activity">
    <div class="page-header">
      <h1>Activity</h1>
    </div>
    <div class="page-content">
      <ul class="activity-list" id="activity-list">
        <!-- Filled by JS from rides table -->
      </ul>
      <div class="activity-empty" id="activity-empty" style="display:none;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        <p>No rides yet</p>
        <p style="font-size:13px;margin-top:8px;">Your trip history will appear here.</p>
      </div>
    </div>
    <div class="bottom-nav">
      <div class="nav-item" data-nav="home"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><span class="nav-label">Home</span></div>
      <div class="nav-item active" data-nav="activity"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg><span class="nav-label">Activity</span></div>
      <div class="nav-item" data-nav="account"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg><span class="nav-label">Account</span></div>
      <div class="nav-item" data-nav="help"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg><span class="nav-label">Help</span></div>
    </div>
  </div>

  <!-- ==================== SCREEN: HELP ==================== -->
  <div class="screen subpage" id="screen-help">
    <div class="page-header">
      <h1>Help</h1>
    </div>
    <div class="page-content">
      <div class="help-section-title">Getting started</div>
      <ul class="help-list">
        <li class="help-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg><span>How to book a ride</span></li>
        <li class="help-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg><span>Changing pickup or destination</span></li>
        <li class="help-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg><span>Payment &amp; receipts</span></li>
      </ul>
      <div class="help-section-title">Safety</div>
      <ul class="help-list">
        <li class="help-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg><span>Safety tips</span></li>
        <li class="help-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/></svg><span>Contact support</span></li>
      </ul>
      <div class="help-section-title">Account</div>
      <ul class="help-list">
        <li class="help-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg><span>Email: support@ridego.no</span></li>
      </ul>
    </div>
    <div class="bottom-nav">
      <div class="nav-item" data-nav="home"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><span class="nav-label">Home</span></div>
      <div class="nav-item" data-nav="activity"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg><span class="nav-label">Activity</span></div>
      <div class="nav-item" data-nav="account"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg><span class="nav-label">Account</span></div>
      <div class="nav-item active" data-nav="help"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg><span class="nav-label">Help</span></div>
    </div>
  </div>

  <!-- ==================== SCREEN: EDIT PROFILE ==================== -->
  <div class="screen subpage" id="screen-edit-profile">
    <div class="page-header">
      <button class="back-btn" id="edit-profile-back"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg></button>
      <h1>Edit Profile</h1>
    </div>
    <div class="page-content">
      <div class="form-group">
        <label>Display name</label>
        <input type="text" id="profile-display-name" placeholder="Your name" maxlength="100">
      </div>
      <div class="form-group">
        <label>Phone (optional)</label>
        <input type="tel" id="profile-phone" placeholder="+47 xxx xx xxx">
      </div>
      <button class="btn-primary" id="profile-save-btn">Save changes</button>
    </div>
  </div>

  <!-- ==================== SCREEN: PAYMENT METHODS ==================== -->
  <div class="screen subpage" id="screen-payment-methods">
    <div class="page-header">
      <button class="back-btn" id="payment-methods-back"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg></button>
      <h1>Payment Methods</h1>
    </div>
    <div class="page-content">
      <div id="payment-methods-list"><!-- Filled by JS --></div>
      <button class="add-payment-btn" id="add-payment-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Add payment method
      </button>
    </div>
  </div>

  <!-- ==================== SCREEN: ADD PAYMENT ==================== -->
  <div class="screen subpage" id="screen-add-payment">
    <div class="page-header">
      <button class="back-btn" id="add-payment-back"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg></button>
      <h1>Add Payment</h1>
    </div>
    <div class="page-content">
      <div style="margin-bottom: 20px;">
        <label class="form-label">Card Brand</label>
        <div class="card-brand-selector" id="card-brand-selector">
          <button class="card-brand-btn selected" data-brand="visa">Visa</button>
          <button class="card-brand-btn" data-brand="mastercard">Mastercard</button>
          <button class="card-brand-btn" data-brand="amex">Amex</button>
        </div>
      </div>
      <div style="margin-bottom: 16px;">
        <label class="form-label">Card Label</label>
        <input type="text" id="new-card-label" class="auth-input" placeholder="e.g. Personal Visa" style="margin-top: 6px;">
      </div>
      <div style="margin-bottom: 16px;">
        <label class="form-label">Last 4 Digits</label>
        <input type="text" id="new-card-last4" class="auth-input" maxlength="4" pattern="[0-9]*" inputmode="numeric" placeholder="1234" style="margin-top: 6px;">
      </div>
      <div style="margin-bottom: 24px; display: flex; align-items: center; gap: 10px;">
        <input type="checkbox" id="new-card-default">
        <label for="new-card-default" style="color: var(--text-secondary); font-size: 14px;">Set as default payment method</label>
      </div>
      <button class="btn-primary" style="width: 100%;" id="save-card-btn">Add Card</button>
    </div>
  </div>

  <!-- ==================== SCREEN: SAFETY ==================== -->
  <div class="screen subpage" id="screen-safety">
    <div class="page-header">
      <button class="back-btn" id="safety-back"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg></button>
      <h1>Safety</h1>
    </div>
    <div class="page-content">
      <a href="tel:112" class="emergency-btn">
        <span style="font-size: 24px;">ðŸš¨</span>
        <div>
          <div style="font-weight: 600; font-size: 16px;">Emergency Call 112</div>
          <div style="font-size: 13px; opacity: 0.8;">Contact emergency services</div>
        </div>
      </a>
      <div class="safety-card">
        <div class="safety-card-title">ðŸ›¡ï¸ Emergency Contacts</div>
        <div id="emergency-contacts-list"></div>
        <div style="display: flex; gap: 8px; margin-top: 12px;">
          <input type="text" id="emergency-name" placeholder="Name" class="auth-input" style="flex: 1; margin: 0; font-size: 14px; padding: 10px 12px;">
          <input type="tel" id="emergency-phone" placeholder="Phone" class="auth-input" style="flex: 1; margin: 0; font-size: 14px; padding: 10px 12px;">
          <button class="btn-primary" style="padding: 10px 16px; white-space: nowrap; font-size: 13px;" id="add-emergency-btn">Add</button>
        </div>
      </div>
      <div class="safety-card">
        <div class="safety-card-title">ðŸ“‹ Safety Tips</div>
        <ul class="safety-tips-list">
          <li>Always verify your driver's name and car details before getting in</li>
          <li>Share your trip status with a trusted contact</li>
          <li>Sit in the back seat when riding alone</li>
          <li>Trust your instincts â€” cancel if something feels wrong</li>
          <li>Keep your phone charged during trips</li>
        </ul>
      </div>
      <div class="safety-card">
        <div class="safety-card-title">ðŸ“ Trip Sharing</div>
        <p style="color: var(--text-secondary); font-size: 14px; margin: 0 0 12px;">Share your live trip status with friends and family during active rides.</p>
        <button class="btn-outline" style="width: 100%;" id="share-trip-safety-btn">Share Current Trip</button>
      </div>
    </div>
  </div>

  <!-- ==================== SCREEN: SETTINGS ==================== -->
  <div class="screen subpage" id="screen-settings">
    <div class="page-header">
      <button class="back-btn" id="settings-back"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg></button>
      <h1>Settings</h1>
    </div>
    <div class="page-content">
      <div class="settings-section">
        <h3 class="settings-section-title">Preferences</h3>
        <div class="setting-row">
          <div class="setting-info">
            <div class="setting-label">Push Notifications</div>
            <div class="setting-desc">Receive ride updates and promotions</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="setting-notifications" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="setting-row">
          <div class="setting-info">
            <div class="setting-label">Sound Effects</div>
            <div class="setting-desc">Play sounds for ride events</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="setting-sounds" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="setting-row">
          <div class="setting-info">
            <div class="setting-label">Email Receipts</div>
            <div class="setting-desc">Receive ride receipts via email</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="setting-receipts" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      <div class="settings-section">
        <h3 class="settings-section-title">About</h3>
        <div class="setting-row">
          <div class="setting-info">
            <div class="setting-label">App Version</div>
            <div class="setting-desc">RideGo Passenger v1.0.0</div>
          </div>
        </div>
        <div class="setting-row">
          <div class="setting-info">
            <div class="setting-label">Terms of Service</div>
            <div class="setting-desc">View our terms and conditions</div>
          </div>
          <span style="color: var(--text-muted);">â€º</span>
        </div>
        <div class="setting-row">
          <div class="setting-info">
            <div class="setting-label">Privacy Policy</div>
            <div class="setting-desc">How we handle your data</div>
          </div>
          <span style="color: var(--text-muted);">â€º</span>
        </div>
      </div>
      <div class="settings-section">
        <button class="btn-text-danger" id="delete-account-btn" style="width: 100%; padding: 14px; text-align: center; font-size: 15px;">Delete Account</button>
      </div>
    </div>
  </div>

  <!-- ==================== SCREEN: INVESTORS ==================== -->
  <div class="screen subpage" id="screen-investors">
    <div class="page-header">
      <button class="back-btn" id="investors-back"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg></button>
      <h1>Investors</h1>
    </div>
    <div class="page-content">
      <div class="investors-total-card" id="investors-total-card">
        <div class="investors-total-label">Total investment</div>
        <div class="investors-total-amount" id="investors-total-amount">â€”</div>
        <div class="investors-total-meta" id="investors-total-meta"></div>
      </div>

      <div class="help-section-title">Add investment</div>
      <form id="investors-form" class="investors-form">
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="investor-name" placeholder="Your name or company" maxlength="200">
          <label class="form-checkbox-label"><input type="checkbox" id="investor-name-anonymous"> Show as anonymous</label>
        </div>
        <div class="form-group">
          <label>Amount (e.g. 50000)</label>
          <input type="number" id="investor-amount" placeholder="Amount" min="0" step="0.01" inputmode="decimal">
          <label class="form-checkbox-label"><input type="checkbox" id="investor-amount-anonymous"> Hide amount</label>
        </div>
        <div class="form-group">
          <label>Contact (optional â€” for us to message you)</label>
          <input type="email" id="investor-email" placeholder="Email" maxlength="255">
          <input type="tel" id="investor-phone" placeholder="Phone" maxlength="50" style="margin-top: 8px;">
        </div>
        <button type="submit" class="btn-primary" id="investors-submit-btn">Submit</button>
      </form>

      <div class="help-section-title" style="margin-top: 24px;">Investors</div>
      <ul class="investors-list" id="investors-list">
        <!-- Filled by JS -->
      </ul>
      <div class="investors-empty" id="investors-empty" style="display:none;">
        <p>No investments yet. Add one above.</p>
      </div>
    </div>
  </div>

  <!-- Location Permission Modal -->
  <div class="location-modal" id="location-modal" style="display:none;">
    <div class="location-modal-card">
      <div class="location-modal-icon">ðŸ“</div>
      <h3>Allow "RideGo" to use your location?</h3>
      <p>We use your location to find your pickup point and show nearby drivers.</p>
      <button class="btn-primary" style="width:100%;" id="location-allow-btn">While Using the App</button>
      <button class="btn-outline" style="width:100%;margin-top:10px;" id="location-deny-btn">Don't Allow</button>
    </div>
  </div>

</div>

<script src="/config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
(function() {
  'use strict';

  // ---- Supabase Setup ----
  var SUPABASE_URL = window.__RIDEGO_SUPABASE_URL || 'https://plpkelkbwcyuglaghsfk.supabase.co';
  var SUPABASE_KEY = window.__RIDEGO_SUPABASE_KEY || 'sb_publishable_anPF5rXktq-YMpHzihweYg_cf6VhRlq';
  var sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ---- Toast & Button Helpers ----
  function showToast(message, type) {
    type = type || 'info';
    var container = document.getElementById('toast-container');
    var toast = document.createElement('div');
    toast.className = 'toast ' + type;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(function() { toast.remove(); }, 3000);
  }

  function setButtonLoading(btn, loading, text) {
    if (loading) {
      btn._originalText = btn.textContent;
      btn.innerHTML = '<span class="btn-spinner"></span>' + (text || 'Loading...');
      btn.classList.add('btn-loading');
    } else {
      btn.textContent = text || btn._originalText || 'Done';
      btn.classList.remove('btn-loading');
    }
  }

  function haptic(ms) { if (navigator.vibrate) navigator.vibrate(ms || 10); }

  // ---- Real-time ride subscription ----
  function subscribeToRide(rideId) {
    if (window._rideSubscription) {
      window._rideSubscription.unsubscribe();
    }
    window._rideSubscription = sb.channel('ride-' + rideId)
      .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rides', filter: 'id=eq.' + rideId }, function(payload) {
        var ride = payload.new;
        if (ride.status === 'driver_assigned' && currentScreen === 'matching') {
          showToast('Driver is on the way!', 'success');
        } else if (ride.status === 'completed') {
          showToast('Trip completed!', 'success');
        } else if (ride.status === 'cancelled') {
          showToast('Ride was cancelled', 'info');
        }
      })
      .subscribe();
  }

  function unsubscribeFromRide() {
    if (window._rideSubscription) {
      window._rideSubscription.unsubscribe();
      window._rideSubscription = null;
    }
  }

  // ---- In-Trip Chat ----
  function escapeHtml(str) {
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function formatChatTime(isoStr) {
    var d = new Date(isoStr);
    return d.getHours().toString().padStart(2, '0') + ':' + d.getMinutes().toString().padStart(2, '0');
  }

  function openChat() {
    isChatOpen = true;
    document.getElementById('chat-overlay').classList.add('open');
    unreadCount = 0;
    document.getElementById('msg-badge').textContent = '';
    if (matchedDriver) {
      document.getElementById('chat-driver-name').textContent = 'Chat with ' + matchedDriver.display_name;
    }
    setTimeout(function() { document.getElementById('chat-input').focus(); }, 350);
    var msgContainer = document.getElementById('chat-messages');
    msgContainer.scrollTop = msgContainer.scrollHeight;
    if (chatMessages.length === 0 && !chatSubscription) {
      loadChatMessages();
      subscribeToChatMessages();
    }
  }

  function closeChat() {
    isChatOpen = false;
    document.getElementById('chat-overlay').classList.remove('open');
    document.getElementById('chat-input').blur();
  }

  async function loadChatMessages() {
    if (!currentRideId) return;
    var result = await sb.from('ride_messages')
      .select('id, sender_type, message, created_at')
      .eq('ride_id', currentRideId)
      .order('created_at', { ascending: true })
      .limit(100);
    if (result.error) {
      console.error('loadChatMessages error:', result.error);
      showToast('Could not load messages', 'error');
      return;
    }
    chatMessages = result.data || [];
    renderChatMessages();
  }

  function renderChatMessages() {
    var container = document.getElementById('chat-messages');
    var emptyEl = document.getElementById('chat-empty');
    if (chatMessages.length === 0) {
      emptyEl.style.display = '';
      // Remove any bubbles
      container.querySelectorAll('.chat-bubble').forEach(function(b) { b.remove(); });
      return;
    }
    emptyEl.style.display = 'none';
    var html = '';
    chatMessages.forEach(function(msg) {
      var isMine = msg.sender_type === 'passenger';
      var cls = isMine ? 'sent' : 'received';
      var time = formatChatTime(msg.created_at);
      html += '<div class="chat-bubble ' + cls + '"><div>' + escapeHtml(msg.message) + '</div><div class="chat-bubble-time">' + time + '</div></div>';
    });
    // Keep empty el (hidden) + add bubbles
    container.innerHTML = '<div class="chat-empty" id="chat-empty" style="display:none;">Send a message to your driver</div>' + html;
    container.scrollTop = container.scrollHeight;
  }

  async function sendChatMessage() {
    var input = document.getElementById('chat-input');
    var text = input.value.trim();
    if (!text) return;
    if (!currentRideId || !currentUser) {
      showToast('Ride is no longer active', 'info');
      closeChat();
      return;
    }
    var sendBtn = document.getElementById('chat-send-btn');
    sendBtn.disabled = true;

    // Optimistic update
    chatMessages.push({ id: 'temp-' + Date.now(), sender_type: 'passenger', message: text, created_at: new Date().toISOString() });
    renderChatMessages();
    input.value = '';

    var result = await sb.from('ride_messages').insert({
      ride_id: currentRideId,
      sender_type: 'passenger',
      message: text
    });

    if (result.error) {
      console.error('sendChatMessage error:', result.error);
      showToast('Failed to send message', 'error');
      // Remove optimistic message
      chatMessages = chatMessages.filter(function(m) { return !String(m.id).startsWith('temp-'); });
      renderChatMessages();
    }
    sendBtn.disabled = !input.value.trim();
  }

  function subscribeToChatMessages() {
    if (!currentRideId) return;
    if (chatSubscription) { chatSubscription.unsubscribe(); }
    chatSubscription = sb.channel('chat-' + currentRideId)
      .on('postgres_changes', {
        event: 'INSERT',
        schema: 'public',
        table: 'ride_messages',
        filter: 'ride_id=eq.' + currentRideId
      }, function(payload) {
        var msg = payload.new;
        // Deduplicate
        if (chatMessages.some(function(m) { return m.id === msg.id; })) return;
        // Remove optimistic temp messages from same sender
        chatMessages = chatMessages.filter(function(m) { return !String(m.id).startsWith('temp-'); });
        chatMessages.push(msg);
        renderChatMessages();
        if (!isChatOpen) {
          unreadCount++;
          document.getElementById('msg-badge').textContent = unreadCount;
          if (msg.sender_type === 'driver') {
            showToast('New message from driver', 'info');
          }
        }
      })
      .subscribe();
  }

  function unsubscribeFromChat() {
    if (chatSubscription) {
      chatSubscription.unsubscribe();
      chatSubscription = null;
    }
    chatMessages = [];
    unreadCount = 0;
    isChatOpen = false;
    document.getElementById('chat-overlay').classList.remove('open');
    document.getElementById('msg-badge').textContent = '';
  }

  // ---- Active Ride Recovery ----
  var activeRideStatuses = ['requested', 'matching', 'driver_assigned', 'arriving', 'in_progress'];

  var statusLabels = {
    requested: 'Finding a driverâ€¦',
    matching: 'Matching with a driverâ€¦',
    driver_assigned: 'Driver assigned',
    arriving: 'Driver is arriving',
    in_progress: 'Trip in progress'
  };

  async function checkActiveRide() {
    if (!currentUser) return;
    var result = await sb.from('rides')
      .select('id, status, pickup_name, dropoff_name, driver_id, ride_type_id, estimated_fare_nok, eta_pickup_min, distance_km, duration_min')
      .eq('passenger_id', currentUser.id)
      .in('status', activeRideStatuses)
      .order('created_at', { ascending: false })
      .limit(1)
      .maybeSingle();

    if (result.error || !result.data) {
      // No active ride, hide banner
      document.getElementById('active-ride-banner').classList.remove('visible');
      return;
    }

    var ride = result.data;
    console.log('Active ride found:', ride.id, ride.status);

    // Store ride id so we don't create a duplicate
    currentRideId = ride.id;

    // Show the banner
    var banner = document.getElementById('active-ride-banner');
    document.getElementById('arb-route').textContent = ride.pickup_name + ' â†’ ' + ride.dropoff_name;
    document.getElementById('arb-status').textContent = statusLabels[ride.status] || ride.status;
    banner.classList.add('visible');

    // Subscribe to ride updates
    subscribeToRide(ride.id);

    // If we have a driver, preload driver info for resume
    if (ride.driver_id && (ride.status === 'arriving' || ride.status === 'in_progress' || ride.status === 'driver_assigned')) {
      var driverResult = await sb.rpc('find_nearby_drivers_latlng', {
        p_lat: 59.9494, // doesn't matter, we just need driver info
        p_lng: 10.7655,
        p_requested_seats: 1
      });

      // Try to find the assigned driver from the results, or query directly
      var driverInfo = null;
      if (driverResult.data) {
        driverInfo = driverResult.data.find(function(d) { return d.driver_id === ride.driver_id; });
      }

      if (!driverInfo) {
        // Query driver info directly
        var dRes = await sb.from('drivers')
          .select('id, display_name, phone, rating_avg, total_trips')
          .eq('id', ride.driver_id)
          .single();
        var vRes = await sb.from('vehicles')
          .select('make, model, color, plate_number')
          .eq('driver_id', ride.driver_id)
          .eq('is_active', true)
          .limit(1)
          .single();

        if (dRes.data) {
          driverInfo = {
            driver_id: dRes.data.id,
            display_name: dRes.data.display_name,
            rating_avg: dRes.data.rating_avg || 4.9,
            total_trips: dRes.data.total_trips || 0,
            eta_min: ride.eta_pickup_min || 3,
            vehicle_make: vRes.data ? vRes.data.make : '',
            vehicle_model: vRes.data ? vRes.data.model : '',
            vehicle_color: vRes.data ? vRes.data.color : '',
            vehicle_plate: vRes.data ? vRes.data.plate_number : ''
          };
        }
      }

      if (driverInfo) {
        matchedDriver = driverInfo;
      }
    }

    // Store destination info for fare card
    selectedDestination = { name: ride.dropoff_name, address: '', lat: 0, lng: 0 };

    // Reconstruct selectedRide for fare display
    if (ride.estimated_fare_nok) {
      selectedRide = {
        estimate: {
          estimated_fare: ride.estimated_fare_nok,
          base_fare: ride.estimated_fare_nok * 0.37,
          distance_fare: ride.estimated_fare_nok * 0.38,
          time_fare: ride.estimated_fare_nok * 0.25,
          distance_km: ride.distance_km || 0,
          duration_min: ride.duration_min || 0
        }
      };
    }
  }

  function resumeActiveRide() {
    if (!currentRideId) return;

    if (matchedDriver) {
      populateTripScreen();
      showScreen('trip');
    } else {
      // No driver yet â€” go to matching screen
      showScreen('matching');
    }
  }

  async function cancelActiveRide() {
    document.getElementById('arb-cancel').textContent = 'Cancelling...';
    await cancelRide();
    document.getElementById('arb-cancel').textContent = 'Cancel Ride';
    document.getElementById('active-ride-banner').classList.remove('visible');
    showToast('Ride cancelled', 'info');
  }

  // ---- Auth UI ----
  var authScreen = document.getElementById('auth-screen');
  var appEl = document.getElementById('app');

  // Tab switching (exposed globally for onclick)
  window.switchAuthTab = function(tab) {
    document.getElementById('tab-signin').classList.toggle('active', tab === 'signin');
    document.getElementById('tab-signup').classList.toggle('active', tab === 'signup');
    document.getElementById('form-signin').classList.toggle('hidden', tab !== 'signin');
    document.getElementById('form-signup').classList.toggle('hidden', tab !== 'signup');
    // Clear errors
    document.getElementById('signin-error').textContent = '';
    document.getElementById('signup-error').textContent = '';
    document.getElementById('signup-success').textContent = '';
  };

  // Sign In
  window.handleSignIn = async function(e) {
    e.preventDefault();
    var btn = document.getElementById('signin-btn');
    var errEl = document.getElementById('signin-error');
    errEl.textContent = '';
    setButtonLoading(btn, true, 'Signing inâ€¦');

    var email = document.getElementById('signin-email').value.trim();
    var password = document.getElementById('signin-password').value;

    var result = await sb.auth.signInWithPassword({ email: email, password: password });
    if (result.error) {
      errEl.textContent = result.error.message;
      setButtonLoading(btn, false, 'Sign In');
      return;
    }

    setButtonLoading(btn, false, 'Sign In');
    // Success â€” show app
    currentUser = result.data.user;
    authScreen.classList.add('hidden');
    appEl.style.display = '';
    initApp();
  };

  // Sign Up
  window.handleSignUp = async function(e) {
    e.preventDefault();
    var btn = document.getElementById('signup-btn');
    var errEl = document.getElementById('signup-error');
    var successEl = document.getElementById('signup-success');
    errEl.textContent = '';
    successEl.textContent = '';
    btn.disabled = true;
    btn.textContent = 'Creating accountâ€¦';

    var name = document.getElementById('signup-name').value.trim();
    var email = document.getElementById('signup-email').value.trim();
    var password = document.getElementById('signup-password').value;

    var result = await sb.auth.signUp({
      email: email,
      password: password,
      options: { data: { display_name: name } }
    });

    if (result.error) {
      errEl.textContent = result.error.message;
      btn.disabled = false;
      btn.textContent = 'Create Account';
      return;
    }

    // If email confirmation is required
    if (result.data.user && !result.data.session) {
      successEl.textContent = 'Check your email to confirm your account, then sign in.';
      btn.disabled = false;
      btn.textContent = 'Create Account';
      return;
    }

    // Auto-signed in (email confirmation disabled)
    currentUser = result.data.user;
    authScreen.classList.add('hidden');
    appEl.style.display = '';
    initApp();
  };

  // Check for existing session on load
  (async function checkSession() {
    var sessionResult = await sb.auth.getSession();
    if (sessionResult.data.session) {
      currentUser = sessionResult.data.session.user;
      authScreen.classList.add('hidden');
      appEl.style.display = '';
      initApp();
    }
  })();

  // ---- Place Coordinates (Oslo) ----
  var PLACES = {
    'Aker Brygge':             { lat: 59.9075, lng: 10.7295, address: 'Brynjulf Bulls plass 6, Oslo' },
    'Oslo Sentralstasjon':     { lat: 59.9111, lng: 10.7528, address: 'Jernbanetorget 1, Oslo' },
    'GrÃ¼nerlÃ¸kka':             { lat: 59.9225, lng: 10.7590, address: 'Thorvald Meyers gate, Oslo' },
    'Nationaltheatret':        { lat: 59.9147, lng: 10.7340, address: 'Johanne Dybwads plass 1, Oslo' },
    'Oslo Lufthavn':           { lat: 60.1939, lng: 11.1004, address: 'Edvard Munchs veg, Gardermoen' },
    'Vigeland Sculpture Park': { lat: 59.9269, lng: 10.7009, address: 'Nobels gate 32, Oslo' },
    'Holmenkollen':            { lat: 59.9617, lng: 10.6673, address: 'Kongeveien 5, Oslo' }
  };
  var PICKUP = { name: 'Nydalen T-banestasjon', address: 'Nydalen allÃ© 1, Oslo', lat: 59.9494, lng: 10.7655 };
  var locationPermission = localStorage.getItem('ridego_location_perm'); // 'granted' | 'denied' | null
  var userLocation = null;

  // ---- State ----
  var currentScreen = 'home';
  var currentUser = null;
  var rideTypes = [];
  var selectedRide = null;         // { id, name, price, estimate }
  var selectedDestination = null;  // { name, address, lat, lng }
  var requestedSeats = 1;
  var currentRideId = null;
  var matchedDriver = null;        // from find_nearby_drivers
  var matchingTimer = null;
  var countdownTimer = null;
  var countdownSeconds = 180;
  var chatMessages = [];
  var chatSubscription = null;
  var unreadCount = 0;
  var isChatOpen = false;

  // ---- DOM Refs ----
  var screens = {
    home: document.getElementById('screen-home'),
    search: document.getElementById('screen-search'),
    'ride-options': document.getElementById('screen-ride-options'),
    matching: document.getElementById('screen-matching'),
    trip: document.getElementById('screen-trip'),
    complete: document.getElementById('screen-complete'),
    account: document.getElementById('screen-account'),
    activity: document.getElementById('screen-activity'),
    help: document.getElementById('screen-help'),
    'edit-profile': document.getElementById('screen-edit-profile'),
    'payment-methods': document.getElementById('screen-payment-methods'),
    'add-payment': document.getElementById('screen-add-payment'),
    safety: document.getElementById('screen-safety'),
    settings: document.getElementById('screen-settings'),
    investors: document.getElementById('screen-investors')
  };

  var $greeting = document.getElementById('greeting');
  var $homeSearch = document.getElementById('home-search');
  var $searchBack = document.getElementById('search-back');
  var $destInput = document.getElementById('dest-input');
  var $suggestionsList = document.getElementById('suggestions-list');
  var $recentList = document.getElementById('recent-list');
  var $rideOptions = document.getElementById('ride-options');
  var $confirmBtn = document.getElementById('confirm-ride-btn');
  var $rideBack = document.getElementById('ride-back');
  var $cancelMatching = document.getElementById('cancel-matching');
  var $completeTripBtn = document.getElementById('complete-trip-btn');
  var $cancelTrip = document.getElementById('cancel-trip');
  var $doneBtn = document.getElementById('done-btn');
  var $stars = document.getElementById('stars');
  var $tipRow = document.getElementById('tip-row');
  var $seatCount = document.getElementById('seat-count');
  var $seatMinus = document.getElementById('seat-minus');
  var $seatPlus = document.getElementById('seat-plus');
  var $arrivingText = document.getElementById('arriving-text');
  var $arrivingCountdown = document.getElementById('arriving-countdown');
  var $destMarkerLabel = document.getElementById('dest-marker-label');
  var $tripDestMarkerLabel = document.getElementById('trip-dest-marker-label');
  var $tripDropoff = document.getElementById('trip-dropoff');
  var $statusTime = document.getElementById('status-time');
  var $fareRoute = document.getElementById('fare-route');
  var $fareBase = document.getElementById('fare-base');
  var $fareDist = document.getElementById('fare-dist');
  var $fareTime = document.getElementById('fare-time');
  var $fareTotal = document.getElementById('fare-total');
  var $matchingSub = document.querySelector('.matching-sub');

  // ---- Greeting ----
  function updateGreeting() {
    var h = new Date().getHours();
    var period;
    if (h >= 5 && h < 12) period = 'morning';
    else if (h >= 12 && h < 17) period = 'afternoon';
    else if (h >= 17 && h < 21) period = 'evening';
    else period = 'night';
    var userName = 'there';
    if (currentUser) {
      userName = (currentUser.user_metadata && currentUser.user_metadata.display_name)
        || (currentUser.email && currentUser.email.split('@')[0])
        || 'there';
    }
    $greeting.textContent = 'Good ' + period + ', ' + userName + ' ðŸ‘‹';
  }

  function updateStatusTime() {
    var d = new Date();
    var h = d.getHours();
    var m = d.getMinutes();
    $statusTime.textContent = (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m;
  }

  // ---- Location Services ----
  function checkLocationPermission() {
    var perm = localStorage.getItem('ridego_location_perm');
    if (perm === 'granted') {
      requestGeolocation();
    } else if (perm === 'denied') {
      updateLocationStatus(false, 'Using default pickup');
    } else {
      // First time â€” show modal
      document.getElementById('location-modal').style.display = '';
    }
  }

  function requestGeolocation() {
    if (!navigator.geolocation) {
      updateLocationStatus(false, 'Geolocation not supported');
      return;
    }
    updateLocationStatus(false, 'Finding your location...');
    navigator.geolocation.getCurrentPosition(
      function(pos) {
        var lat = pos.coords.latitude;
        var lng = pos.coords.longitude;
        userLocation = { lat: lat, lng: lng };
        PICKUP.lat = lat;
        PICKUP.lng = lng;
        updateLocationStatus(true, 'Current location');
        reverseGeocodePickup(lat, lng);
        updateGmapLocation(lat, lng);
      },
      function(err) {
        console.error('Geolocation error:', err.message);
        updateLocationStatus(false, 'Location unavailable');
        showToast('Could not get location, using default pickup', 'info');
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
    );
  }

  async function reverseGeocodePickup(lat, lng) {
    try {
      var resp = await fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + lat + '&lon=' + lng + '&zoom=18&addressdetails=1', {
        headers: { 'Accept-Language': 'en' }
      });
      var data = await resp.json();
      if (data && data.address) {
        var a = data.address;
        PICKUP.name = a.road || a.neighbourhood || a.suburb || 'Current Location';
        PICKUP.address = [a.road, a.house_number, a.city || a.town || a.village].filter(Boolean).join(', ') || data.display_name.split(',').slice(0, 2).join(',');
      } else {
        PICKUP.name = 'Current Location';
        PICKUP.address = lat.toFixed(4) + ', ' + lng.toFixed(4);
      }
    } catch (e) {
      PICKUP.name = 'Current Location';
      PICKUP.address = lat.toFixed(4) + ', ' + lng.toFixed(4);
    }
    updatePickupDisplays();
  }

  function updatePickupDisplays() {
    // Update all places that show the pickup name
    var greenLabels = document.querySelectorAll('.marker-green .marker-label');
    greenLabels.forEach(function(el) { el.textContent = PICKUP.name; });
    // Update trip timeline pickup value (first .tl-value)
    var tlValues = document.querySelectorAll('.trip-timeline .tl-value');
    if (tlValues.length > 0) tlValues[0].textContent = PICKUP.name;
    // Update search screen "Current Location" display
    var staticField = document.querySelector('.search-field-static');
    if (staticField) staticField.textContent = PICKUP.name;
  }

  function updateLocationStatus(active, text) {
    var dot = document.getElementById('location-dot');
    var statusText = document.getElementById('location-status-text');
    if (dot) {
      if (active) { dot.classList.add('active'); } else { dot.classList.remove('active'); }
    }
    if (statusText) statusText.textContent = text;
  }

  // ---- Screen Navigation ----
  function showScreen(name) {
    clearTimeout(matchingTimer);
    clearInterval(countdownTimer);

    // Cleanup chat when leaving trip screen
    if (currentScreen === 'trip' && name !== 'trip') {
      closeChat();
    }

    var prev = screens[currentScreen];
    var next = screens[name];
    if (prev === next) return;

    prev.classList.remove('active');
    prev.classList.add('slide-out-left');

    next.classList.remove('slide-out-left', 'slide-in-right');
    next.classList.add('active');

    setTimeout(function() { prev.classList.remove('slide-out-left'); }, 350);

    currentScreen = name;

    // Screen-specific init
    if (name === 'search') {
      setTimeout(function() { $destInput.focus(); }, 100);
      $destInput.value = '';
      filterSuggestions('');
    }
    if (name === 'ride-options') {
      requestedSeats = 1;
      loadRideOptions();
    }
    if (name === 'matching') {
      startMatching();
    }
    if (name === 'trip') {
      startCountdown();
      loadChatMessages();
      subscribeToChatMessages();
    }
    if (name === 'complete') {
      completeRide();
    }
    if (name === 'settings') {
      loadSettings();
    }
    if (name === 'safety') {
      loadEmergencyContacts();
    }
    if (name === 'investors') {
      loadInvestors();
    }
  }

  function goBack(from) {
    clearTimeout(matchingTimer);
    clearInterval(countdownTimer);

    var prev = screens[currentScreen];
    var map = { search: 'home', 'ride-options': 'search', matching: 'home', trip: 'home', 'edit-profile': 'account', 'payment-methods': 'account', 'add-payment': 'payment-methods', safety: 'account', settings: 'account', investors: 'account' };
    var target = map[from] || 'home';
    var next = screens[target];

    prev.classList.remove('active');
    prev.classList.add('anim-back-out');
    next.classList.remove('slide-out-left', 'slide-in-right', 'anim-back-out');
    next.classList.add('active', 'anim-back-in');

    setTimeout(function() {
      prev.classList.remove('anim-back-out');
      next.classList.remove('anim-back-in');
    }, 350);

    currentScreen = target;
    if (target === 'search') {
      setTimeout(function() { $destInput.focus(); }, 100);
    }
  }

  // ---- Search Filtering ----
  function filterSuggestions(query) {
    var q = query.toLowerCase().trim();
    var filterList = function(items) {
      items.forEach(function(item) {
        var name = (item.getAttribute('data-name') || '').toLowerCase();
        item.style.display = (!q || name.indexOf(q) !== -1) ? '' : 'none';
      });
    };
    filterList($recentList.querySelectorAll('.suggestion-item'));
    filterList($suggestionsList.querySelectorAll('.suggestion-item'));
  }

  // ---- Select a destination (from search or home) ----
  function selectDestination(name, address, lat, lng) {
    var place = PLACES[name];
    if (!place && lat && lng) {
      place = { lat: lat, lng: lng, address: address || name };
    }
    if (!place) return;
    selectedDestination = { name: name, lat: place.lat, lng: place.lng, address: place.address };

    // Save to recent_searches
    if (currentUser) {
      sb.from('recent_searches').insert({
        user_id: currentUser.id,
        name: name,
        address: place.address || '',
        location: 'POINT(' + place.lng + ' ' + place.lat + ')'
      }).then(function() {});
    }

    var label = name.length > 20 ? name.substring(0, 18) + 'â€¦' : name;
    $destMarkerLabel.textContent = label;
    if ($tripDestMarkerLabel) $tripDestMarkerLabel.textContent = label;
    $tripDropoff.textContent = name;
    showScreen('ride-options');
  }

  // ---- Load Recent Searches from DB ----
  async function loadRecentSearches() {
    if (!currentUser) return;
    var result = await sb.from('recent_searches')
      .select('name, address, location, searched_at')
      .eq('user_id', currentUser.id)
      .order('searched_at', { ascending: false })
      .limit(5);

    if (result.error || !result.data || result.data.length === 0) return;
    // Parse geography POINT from location and enrich with lat/lng
    var data = result.data.map(function(r) {
      var lat = 0, lng = 0;
      // Check PLACES lookup first
      if (PLACES[r.name]) {
        lat = PLACES[r.name].lat;
        lng = PLACES[r.name].lng;
      } else if (r.location && typeof r.location === 'string') {
        // Parse "POINT(lng lat)" or "SRID=4326;POINT(lng lat)"
        var m = r.location.match(/POINT\(([-\d.]+)\s+([-\d.]+)\)/i);
        if (m) { lng = parseFloat(m[1]); lat = parseFloat(m[2]); }
      }
      return { name: r.name, address: r.address, lat: lat, lng: lng, searched_at: r.searched_at };
    });

    // Update home screen recent places
    var homeList = document.querySelector('#screen-home .place-list');
    if (homeList) {
      homeList.innerHTML = data.map(function(p) {
        return '<li class="place-item" data-name="' + (p.name || '').replace(/"/g, '&quot;') + '" data-lat="' + (p.lat || '') + '" data-lng="' + (p.lng || '') + '" data-address="' + (p.address || '').replace(/"/g, '&quot;') + '">' +
          '<span class="place-icon">ðŸ•’</span>' +
          '<div class="place-info"><div class="place-name">' + (p.name || 'Unknown') + '</div>' +
          '<div class="place-address">' + (p.address || '') + '</div></div></li>';
      }).join('');
    }

    // Update search screen recent list
    var searchList = document.getElementById('recent-list');
    if (searchList) {
      searchList.innerHTML = data.map(function(p) {
        return '<li class="suggestion-item" data-name="' + (p.name || '').replace(/"/g, '&quot;') + '" data-lat="' + (p.lat || '') + '" data-lng="' + (p.lng || '') + '" data-address="' + (p.address || '').replace(/"/g, '&quot;') + '">' +
          '<span class="place-icon">ðŸ•’</span>' +
          '<div class="place-info"><div class="place-name">' + (p.name || 'Unknown') + '</div>' +
          '<div class="place-address">' + (p.address || '') + '</div></div></li>';
      }).join('');
    }
  }

  // ---- Fetch real route from Google Routes API (via edge function) ----
  var cachedRoute = null; // { distance_km, duration_min, polyline }

  async function fetchRoute(pickupLat, pickupLng, dropoffLat, dropoffLng) {
    try {
      var res = await sb.functions.invoke('get-route', {
        body: {
          pickup_lat: pickupLat,
          pickup_lng: pickupLng,
          dropoff_lat: dropoffLat,
          dropoff_lng: dropoffLng
        }
      });
      if (res.error) {
        console.warn('get-route error, falling back to straight-line:', res.error);
        return null;
      }
      console.log('Google Routes API result:', res.data);
      return res.data; // { distance_km, duration_min, polyline }
    } catch (err) {
      console.warn('get-route fetch failed, falling back to straight-line:', err);
      return null;
    }
  }

  // ---- Load ride options with real fares from DB ----
  async function loadRideOptions() {
    if (!selectedDestination || rideTypes.length === 0) return;
    cachedRoute = null; // Reset for new destination

    // Show skeleton loading state
    $rideOptions.innerHTML = '<div class="skeleton skeleton-ride"></div><div class="skeleton skeleton-ride"></div><div class="skeleton skeleton-ride"></div>';
    $confirmBtn.disabled = true;
    setButtonLoading($confirmBtn, true, 'Calculating...');

    // 1. Get real route from Google Routes API
    cachedRoute = await fetchRoute(
      PICKUP.lat, PICKUP.lng,
      selectedDestination.lat, selectedDestination.lng
    );

    // Update map polyline with real route data
    if (_gmapsReady && _gmapInstances.ride && selectedDestination) {
      _drawPolyline('ride', _gmapInstances.ride,
        { lat: PICKUP.lat, lng: PICKUP.lng },
        { lat: selectedDestination.lat, lng: selectedDestination.lng }
      );
    }

    // 2. Get fare estimates for all ride types, passing real route data if available
    var estimates = await Promise.all(rideTypes.map(function(rt) {
      var rpcParams = {
        p_ride_type_id: rt.id,
        p_pickup_lat: PICKUP.lat,
        p_pickup_lng: PICKUP.lng,
        p_dropoff_lat: selectedDestination.lat,
        p_dropoff_lng: selectedDestination.lng
      };
      // Pass real route data to get accurate fares
      if (cachedRoute) {
        rpcParams.p_real_distance_km = cachedRoute.distance_km;
        rpcParams.p_real_duration_min = cachedRoute.duration_min;
      }
      return sb.rpc('estimate_fare_latlng', rpcParams).then(function(res) {
        return { rideType: rt, estimate: res.error ? null : res.data };
      });
    }));

    // Render ride option cards
    var html = '';
    estimates.forEach(function(item, i) {
      var rt = item.rideType;
      var est = item.estimate;
      var price = est ? Math.round(est.estimated_fare) : rt.min_fare_nok;
      var eta = est ? Math.round(est.duration_min) : '~';
      var selClass = i === 0 ? 'selected' : '';
      html +=
        '<div class="ride-option ' + selClass + '" data-ride-id="' + rt.id + '" data-ride="' + rt.name.toLowerCase() + '" data-price="' + price + '" data-seats="' + rt.max_passengers + '">' +
          '<div class="ride-icon">' + rt.icon + '</div>' +
          '<div class="ride-info">' +
            '<div class="ride-name">' + rt.name + '</div>' +
            '<div class="ride-desc"><span class="seat-badge">' + rt.max_passengers + ' seats</span> Â· ' + rt.description + '</div>' +
          '</div>' +
          '<div class="ride-meta">' +
            '<div class="ride-eta">' + eta + ' min</div>' +
            '<div class="ride-price">kr ' + price + '</div>' +
          '</div>' +
        '</div>';
    });
    $rideOptions.innerHTML = html;

    // Store estimates for fare breakdown later
    $rideOptions._estimates = estimates;

    // Select first option
    var firstOption = $rideOptions.querySelector('.ride-option');
    if (firstOption) selectRide(firstOption);

    // Apply seat filter
    updateSeatSelector();

    $confirmBtn.disabled = false;
    setButtonLoading($confirmBtn, false);
  }

  // ---- Ride Selection ----
  function selectRide(el) {
    var options = $rideOptions.querySelectorAll('.ride-option');
    options.forEach(function(opt) { opt.classList.remove('selected'); });
    el.classList.add('selected');

    var name = el.querySelector('.ride-name').textContent;
    var price = el.getAttribute('data-price');
    var rideTypeId = el.getAttribute('data-ride-id');

    // Find the estimate for this ride type
    var estimateData = null;
    if ($rideOptions._estimates) {
      var found = $rideOptions._estimates.find(function(e) { return e.rideType.id === rideTypeId; });
      if (found) estimateData = found.estimate;
    }

    selectedRide = { id: rideTypeId, name: name, price: parseInt(price, 10), estimate: estimateData };
    $confirmBtn.textContent = 'Confirm ' + name + ' â€” kr ' + price;
  }

  // ---- Matching: create ride + find driver ----
  async function startMatching() {
    // Prevent double-booking
    if (currentRideId) {
      showToast('You already have an active ride', 'info');
      return;
    }
    document.getElementById('active-ride-banner').classList.remove('visible');
    $matchingSub.textContent = 'Searching nearby drivers...';

    // 1. Create ride via request_ride RPC
    var rpcResult = await sb.rpc('request_ride', {
      p_ride_type_id: selectedRide.id,
      p_pickup_name: PICKUP.name,
      p_pickup_address: PICKUP.address,
      p_pickup_lat: PICKUP.lat,
      p_pickup_lng: PICKUP.lng,
      p_dropoff_name: selectedDestination.name,
      p_dropoff_address: selectedDestination.address,
      p_dropoff_lat: selectedDestination.lat,
      p_dropoff_lng: selectedDestination.lng,
      p_requested_seats: requestedSeats
    });

    if (rpcResult.error) {
      console.error('request_ride error:', rpcResult.error);
      showToast(rpcResult.error.message, 'error');
      $matchingSub.textContent = 'Error: ' + rpcResult.error.message;
      return;
    }

    currentRideId = rpcResult.data.ride_id;
    console.log('Ride created:', currentRideId);
    subscribeToRide(currentRideId);

    // Store polyline from Google Routes on the ride record (if available)
    if (cachedRoute && cachedRoute.polyline) {
      sb.from('rides')
        .update({ route_polyline: cachedRoute.polyline })
        .eq('id', currentRideId)
        .then(function(res) {
          if (res.error) console.warn('Could not save polyline:', res.error);
        });
    }

    // 2. Find nearby drivers
    $matchingSub.textContent = 'Found ride, matching driver...';

    var driversResult = await sb.rpc('find_nearby_drivers_latlng', {
      p_lat: PICKUP.lat,
      p_lng: PICKUP.lng,
      p_requested_seats: requestedSeats
    });

    if (driversResult.error || !driversResult.data || driversResult.data.length === 0) {
      console.log('No real drivers found â€” using demo driver');
      $matchingSub.textContent = 'Demo mode: assigning test driver...';
      // Use a fake demo driver so we can test the full flow
      driversResult = { data: [{
        driver_id: 'd1111111-1111-1111-1111-111111111111',
        display_name: 'Mohamed K.',
        rating_avg: 4.92,
        total_trips: 847,
        vehicle_make: 'Toyota',
        vehicle_model: 'Camry',
        vehicle_color: 'White',
        vehicle_plate: 'EL 12345',
        vehicle_type: 'sedan',
        available_seats: 4,
        distance_meters: 1200,
        eta_min: 3
      }]};
    }

    // 3. Pick closest driver
    matchedDriver = driversResult.data[0];
    console.log('Matched driver:', matchedDriver.display_name);
    $matchingSub.textContent = 'Driver found: ' + matchedDriver.display_name + '!';

    // 4. Assign driver to ride (update ride record)
    // Need to find the vehicle_id for this driver
    var vehicleResult = await sb.from('vehicles')
      .select('id')
      .eq('driver_id', matchedDriver.driver_id)
      .eq('is_active', true)
      .limit(1)
      .single();

    var vehicleId = vehicleResult.data ? vehicleResult.data.id : null;

    await sb.from('rides')
      .update({
        driver_id: matchedDriver.driver_id,
        vehicle_id: vehicleId,
        status: 'arriving',
        matched_at: new Date().toISOString(),
        eta_pickup_min: matchedDriver.eta_min || 3
      })
      .eq('id', currentRideId);

    // 5. Update trip screen with real driver data
    populateTripScreen();

    // 6. Transition to trip screen after brief delay
    matchingTimer = setTimeout(function() {
      showScreen('trip');
    }, 1500);
  }

  // ---- Populate trip screen with matched driver ----
  function populateTripScreen() {
    if (!matchedDriver) return;
    var d = matchedDriver;
    var avatar = document.querySelector('#screen-trip .driver-avatar');
    var nameEl = document.querySelector('#screen-trip .driver-name');
    var ratingEl = document.querySelector('#screen-trip .driver-rating');
    var carEl = document.querySelector('#screen-trip .driver-car');

    avatar.textContent = d.display_name.charAt(0);
    nameEl.textContent = d.display_name;
    ratingEl.textContent = d.rating_avg + ' â­ Â· ' + d.total_trips + ' trips';
    carEl.textContent = d.vehicle_color + ' ' + d.vehicle_make + ' ' + d.vehicle_model + ' Â· ' + d.vehicle_plate;

    // Set ETA
    var eta = Math.max(Math.round(d.eta_min || 1), 1);
    countdownSeconds = eta * 60;
  }

  // ---- Countdown ----
  function startCountdown() {
    clearInterval(countdownTimer);
    if (matchedDriver && matchedDriver.eta_min) {
      countdownSeconds = Math.max(Math.round(matchedDriver.eta_min), 1) * 60;
    }
    updateCountdownDisplay();
    countdownTimer = setInterval(function() {
      countdownSeconds--;
      if (countdownSeconds <= 0) {
        clearInterval(countdownTimer);
        countdownSeconds = 0;
      }
      updateCountdownDisplay();
    }, 1000);
  }

  function updateCountdownDisplay() {
    var m = Math.floor(countdownSeconds / 60);
    var s = countdownSeconds % 60;
    $arrivingCountdown.textContent = m + ':' + (s < 10 ? '0' : '') + s;
    var mins = Math.ceil(countdownSeconds / 60);
    $arrivingText.textContent = 'Arriving in ' + mins + ' min';
  }

  // ---- Complete Ride ----
  async function completeRide() {
    // Cleanup chat
    unsubscribeFromChat();

    // Update ride to completed in DB
    if (currentRideId) {
      var result = await sb.rpc('complete_ride', { p_ride_id: currentRideId });
      if (result.error) {
        console.error('complete_ride error:', result.error);
        showToast(result.error.message, 'error');
      } else {
        console.log('Ride completed:', currentRideId);
      }
    }
    updateFareCard();
    resetComplete();
  }

  // ---- Fare Card (use real estimate data) ----
  function updateFareCard() {
    var est = selectedRide ? selectedRide.estimate : null;
    var destName = selectedDestination ? selectedDestination.name : 'Destination';

    $fareRoute.textContent = PICKUP.name + ' â†’ ' + destName;

    if (est) {
      $fareBase.textContent = 'kr ' + Math.round(est.base_fare);
      $fareDist.textContent = 'kr ' + Math.round(est.distance_fare);
      $fareTime.textContent = 'kr ' + Math.round(est.time_fare);
      $fareTotal.textContent = 'kr ' + Math.round(est.estimated_fare);

      // Update distance/time labels
      var distRow = $fareDist.parentElement;
      var timeRow = $fareTime.parentElement;
      distRow.querySelector('span:first-child').textContent = 'Distance (' + est.distance_km + ' km)';
      timeRow.querySelector('span:first-child').textContent = 'Time (' + est.duration_min + ' min)';
    } else {
      var total = selectedRide ? selectedRide.price : 89;
      $fareBase.textContent = 'kr ' + Math.round(total * 0.55);
      $fareDist.textContent = 'kr ' + Math.round(total * 0.38);
      $fareTime.textContent = 'kr ' + (total - Math.round(total * 0.55) - Math.round(total * 0.38));
      $fareTotal.textContent = 'kr ' + total;
    }
  }

  // ---- Trip Complete Reset ----
  function resetComplete() {
    var starBtns = $stars.querySelectorAll('.star-btn');
    starBtns.forEach(function(b) { b.classList.remove('active'); });
    var tipBtns = $tipRow.querySelectorAll('.tip-btn');
    tipBtns.forEach(function(b) { b.classList.remove('active'); });
    tipBtns[0].classList.add('active');
    var comment = document.querySelector('.comment-box');
    if (comment) comment.value = '';
  }

  // ---- Seat selector ----
  function updateSeatSelector() {
    $seatCount.textContent = requestedSeats;
    $seatMinus.disabled = requestedSeats <= 1;
    $seatPlus.disabled = requestedSeats >= 8;
    var options = $rideOptions.querySelectorAll('.ride-option');
    var selectedStillValid = false;
    options.forEach(function(opt) {
      var seats = parseInt(opt.getAttribute('data-seats'), 10);
      if (seats < requestedSeats) {
        opt.style.opacity = '0.35';
        opt.style.pointerEvents = 'none';
        opt.classList.remove('selected');
      } else {
        opt.style.opacity = '';
        opt.style.pointerEvents = '';
        if (opt.classList.contains('selected')) selectedStillValid = true;
      }
    });
    if (!selectedStillValid) {
      var firstValid = $rideOptions.querySelector('.ride-option:not([style*="pointer-events: none"])');
      if (firstValid) selectRide(firstValid);
    }
  }

  // ---- Submit Rating ----
  async function submitRating() {
    if (!currentRideId) { showScreen('home'); return; }

    setButtonLoading($doneBtn, true, 'Submitting...');

    // Get star rating
    var activeStars = $stars.querySelectorAll('.star-btn.active');
    var starCount = activeStars.length;
    if (starCount === 0) starCount = 5; // default to 5 if none selected

    // Get tip
    var activeTip = $tipRow.querySelector('.tip-btn.active');
    var tipAmount = activeTip ? parseInt(activeTip.getAttribute('data-tip'), 10) : 0;

    // Get comment
    var comment = document.querySelector('.comment-box');
    var commentText = comment ? comment.value.trim() : null;

    var result = await sb.rpc('rate_ride', {
      p_ride_id: currentRideId,
      p_stars: starCount,
      p_tip_nok: tipAmount,
      p_comment: commentText || null
    });

    setButtonLoading($doneBtn, false, 'Done');

    if (result.error) {
      console.error('rate_ride error:', result.error);
      showToast(result.error.message, 'error');
    } else {
      console.log('Rating submitted:', result.data);
      showToast('Thanks for your feedback!', 'success');
    }

    // Reset state
    unsubscribeFromRide();
    unsubscribeFromChat();
    currentRideId = null;
    matchedDriver = null;
    selectedRide = null;
    selectedDestination = null;

    showScreen('home');
  }

  // ---- Cancel Ride in DB ----
  async function cancelRide() {
    if (currentRideId) {
      var result = await sb.rpc('cancel_ride', { p_ride_id: currentRideId });
      if (result.error) {
        console.error('cancel_ride error:', result.error);
        showToast(result.error.message, 'error');
      } else {
        console.log('Ride cancelled:', currentRideId);
        showToast('Ride cancelled', 'info');
      }
      unsubscribeFromRide();
      unsubscribeFromChat();
      currentRideId = null;
      matchedDriver = null;
    }
  }

  // ---- Nav Bar (bottom navigation) ----
  function updateNavActive(screenName) {
    document.querySelectorAll('.bottom-nav .nav-item').forEach(function(item) {
      var nav = item.getAttribute('data-nav');
      item.classList.toggle('active', nav === screenName);
    });
  }

  document.querySelectorAll('.bottom-nav .nav-item[data-nav]').forEach(function(item) {
    item.addEventListener('click', function() {
      var target = this.getAttribute('data-nav');
      if (target === 'home') {
        showScreen('home');
      } else if (target === 'account') {
        populateAccount();
        showScreen('account');
      } else if (target === 'activity') {
        loadActivityRides();
        showScreen('activity');
      } else if (target === 'help') {
        showScreen('help');
      }
    });
  });

  // Account menu items â†’ sub-pages
  document.querySelectorAll('#screen-account .account-menu-item[data-page]').forEach(function(item) {
    item.addEventListener('click', function() {
      var page = this.getAttribute('data-page');
      if (page === 'edit-profile') loadProfileForm();
      if (page === 'payment-methods') loadPaymentMethods();
      // safety and settings are initialized via showScreen hooks
      showScreen(page);
    });
  });

  // Back from sub-pages to Account
  document.getElementById('edit-profile-back').addEventListener('click', function() { goBack('edit-profile'); });
  document.getElementById('payment-methods-back').addEventListener('click', function() { goBack('payment-methods'); });
  document.getElementById('safety-back').addEventListener('click', function() { goBack('safety'); });
  document.getElementById('settings-back').addEventListener('click', function() { goBack('settings'); });
  document.getElementById('investors-back').addEventListener('click', function() { goBack('investors'); });

  // Populate account screen with user data
  function populateAccount() {
    if (!currentUser) return;
    var name = (currentUser.user_metadata && currentUser.user_metadata.display_name)
      || (currentUser.email && currentUser.email.split('@')[0])
      || 'User';
    var email = currentUser.email || '';
    var initial = name.charAt(0).toUpperCase();

    document.getElementById('account-avatar').textContent = initial;
    document.getElementById('account-name').textContent = name;
    document.getElementById('account-email').textContent = email;
  }

  // Load activity (ride history) from DB
  async function loadActivityRides() {
    var listEl = document.getElementById('activity-list');
    var emptyEl = document.getElementById('activity-empty');
    emptyEl.style.display = 'none';
    listEl.innerHTML = '<div class="skeleton skeleton-activity"></div><div class="skeleton skeleton-activity"></div><div class="skeleton skeleton-activity"></div>';
    if (!currentUser) {
      listEl.innerHTML = '';
      emptyEl.style.display = 'block';
      return;
    }
    var result = await sb.from('rides')
      .select('id, pickup_name, dropoff_name, status, estimated_fare_nok, final_fare_nok, requested_at')
      .eq('passenger_id', currentUser.id)
      .order('requested_at', { ascending: false })
      .limit(50);
    if (result.error) {
      listEl.innerHTML = '';
      emptyEl.style.display = 'block';
      emptyEl.querySelector('p').textContent = 'Could not load rides.';
      showToast(result.error.message, 'error');
      return;
    }
    var rides = result.data || [];
    if (rides.length === 0) {
      listEl.innerHTML = '';
      emptyEl.style.display = 'block';
      emptyEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸš—</div><div class="empty-state-text">No rides yet. Book your first trip!</div></div>';
      return;
    }
    emptyEl.style.display = 'none';
    listEl.innerHTML = rides.map(function(r) {
      var route = r.pickup_name + ' â†’ ' + r.dropoff_name;
      var fare = (r.final_fare_nok != null ? r.final_fare_nok : r.estimated_fare_nok);
      var dateStr = r.requested_at ? new Date(r.requested_at).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' }) : '';
      var isCompleted = r.status === 'completed';
      var statusClass = isCompleted ? 'completed' : 'cancelled';
      var statusText = isCompleted ? ('kr ' + Math.round(fare)) :
        (r.status || 'â€”').replace(/_/g, ' ').replace(/\b\w/g, function(c) { return c.toUpperCase(); });
      return '<li class="activity-item">' +
        '<div class="activity-route">' + escapeHtml(route) + '</div>' +
        '<div class="activity-meta"><span>' + escapeHtml(dateStr) + '</span><span>kr ' + Math.round(fare) + '</span></div>' +
        '<div class="activity-status ' + statusClass + '">' + escapeHtml(statusText) + '</div>' +
        '</li>';
    }).join('');
  }

  function escapeHtml(s) {
    if (!s) return '';
    var div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }

  // Load profile form for Edit Profile
  async function loadProfileForm() {
    if (!currentUser) return;
    var res = await sb.from('profiles').select('display_name, phone').eq('id', currentUser.id).single();
    var displayName = '';
    var phone = '';
    if (!res.error && res.data) {
      displayName = res.data.display_name || '';
      phone = res.data.phone || '';
    } else {
      displayName = (currentUser.user_metadata && currentUser.user_metadata.display_name) || (currentUser.email && currentUser.email.split('@')[0]) || '';
    }
    document.getElementById('profile-display-name').value = displayName;
    document.getElementById('profile-phone').value = phone;
  }

  // Save profile
  document.getElementById('profile-save-btn').addEventListener('click', async function() {
    if (!currentUser) return;
    var btn = this;
    var displayName = document.getElementById('profile-display-name').value.trim();
    var phone = document.getElementById('profile-phone').value.trim();
    setButtonLoading(btn, true, 'Savingâ€¦');
    var res = await sb.from('profiles').update({ display_name: displayName || null, phone: phone || null, updated_at: new Date().toISOString() }).eq('id', currentUser.id).select();
    setButtonLoading(btn, false, 'Save changes');
    if (res.error) {
      console.error('Profile update failed:', res.error);
      showToast(res.error.message, 'error');
      return;
    }
    if (currentUser.user_metadata) currentUser.user_metadata.display_name = displayName;
    else currentUser.user_metadata = { display_name: displayName };
    showToast('Profile updated!', 'success');
    populateAccount();
    showScreen('account');
  });

  // Load payment methods for Payment Methods screen
  async function loadPaymentMethods() {
    var container = document.getElementById('payment-methods-list');
    if (!currentUser) {
      container.innerHTML = '<p style="color:var(--text-muted);font-size:14px;">Sign in to manage payment methods.</p>';
      return;
    }
    var res = await sb.from('payment_methods').select('id, label, is_default').eq('user_id', currentUser.id).order('is_default', { ascending: false });
    if (res.error || !res.data || res.data.length === 0) {
      container.innerHTML = '<p style="color:var(--text-muted);font-size:14px;">No payment methods added yet.</p>';
      return;
    }
    container.innerHTML = res.data.map(function(pm) {
      var defaultLabel = pm.is_default ? '<div class="pm-default">Default</div>' : '';
      return '<div class="payment-method-item ' + (pm.is_default ? 'default' : '') + '">' +
        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>' +
        '<div><div class="pm-label">' + escapeHtml(pm.label) + '</div>' + defaultLabel + '</div></div>';
    }).join('');
  }

  document.getElementById('add-payment-btn').addEventListener('click', function() {
    showScreen('add-payment');
  });

  // ---- Settings (localStorage) ----
  function loadSettings() {
    var settings = JSON.parse(localStorage.getItem('ridego_settings') || '{}');
    document.getElementById('setting-notifications').checked = settings.notifications !== false;
    document.getElementById('setting-sounds').checked = settings.sounds !== false;
    document.getElementById('setting-receipts').checked = settings.receipts !== false;
  }

  function saveSettings() {
    var settings = {
      notifications: document.getElementById('setting-notifications').checked,
      sounds: document.getElementById('setting-sounds').checked,
      receipts: document.getElementById('setting-receipts').checked
    };
    localStorage.setItem('ridego_settings', JSON.stringify(settings));
  }

  // Wire up settings toggles
  ['setting-notifications', 'setting-sounds', 'setting-receipts'].forEach(function(id) {
    document.getElementById(id).addEventListener('change', saveSettings);
  });

  // Delete account button
  document.getElementById('delete-account-btn').addEventListener('click', function() {
    if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
      showToast('Please contact support@ridego.no', 'info');
    }
  });

  // ---- Investors (Supabase) ----
  async function loadInvestors() {
    var totalEl = document.getElementById('investors-total-amount');
    var metaEl = document.getElementById('investors-total-meta');
    var listEl = document.getElementById('investors-list');
    var emptyEl = document.getElementById('investors-empty');

    var res = await sb.from('investors').select('id, name, amount, name_is_anonymous, amount_is_anonymous, contact_email, contact_phone, created_at').order('created_at', { ascending: false });
    if (res.error) {
      totalEl.textContent = 'â€”';
      metaEl.textContent = '';
      listEl.innerHTML = '';
      emptyEl.style.display = 'block';
      showToast(res.error.message || 'Could not load investors', 'error');
      return;
    }
    var rows = res.data || [];
    var total = 0;
    var anonymousCount = 0;
    rows.forEach(function(r) {
      if (!r.amount_is_anonymous && r.amount != null) total += Number(r.amount);
      else if (r.amount != null) anonymousCount++;
    });
    totalEl.textContent = 'kr ' + (total % 1 === 0 ? Math.round(total) : total.toFixed(2));
    if (anonymousCount > 0) metaEl.textContent = anonymousCount + ' anonymous investment(s) not included';
    else metaEl.textContent = rows.length + ' investor(s)';

    if (rows.length === 0) {
      listEl.innerHTML = '';
      emptyEl.style.display = 'block';
      return;
    }
    emptyEl.style.display = 'none';
    listEl.innerHTML = rows.map(function(r) {
      var name = r.name_is_anonymous ? 'Anonymous' : (r.name || 'â€”');
      var amount = r.amount_is_anonymous ? 'â€”' : (r.amount != null ? 'kr ' + (Number(r.amount) % 1 === 0 ? Math.round(r.amount) : Number(r.amount).toFixed(2)) : 'â€”');
      var contact = [];
      if (r.contact_email) contact.push('ðŸ“§ ' + escapeHtml(r.contact_email));
      if (r.contact_phone) contact.push('ðŸ“ž ' + escapeHtml(r.contact_phone));
      var contactHtml = contact.length ? '<div class="investors-item-contact">' + contact.join(' Â· ') + '</div>' : '';
      return '<li class="investors-item"><div><span class="investors-item-name">' + escapeHtml(name) + '</span>' + contactHtml + '</div><span class="investors-item-amount">' + amount + '</span></li>';
    }).join('');
  }

  document.getElementById('investors-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    var name = document.getElementById('investor-name').value.trim();
    var amountRaw = document.getElementById('investor-amount').value.trim();
    var amount = amountRaw === '' ? null : parseFloat(amountRaw);
    var nameAnonymous = document.getElementById('investor-name-anonymous').checked;
    var amountAnonymous = document.getElementById('investor-amount-anonymous').checked;
    var email = document.getElementById('investor-email').value.trim() || null;
    var phone = document.getElementById('investor-phone').value.trim() || null;

    if (!nameAnonymous && !name) { showToast('Enter a name or check "Show as anonymous"', 'error'); return; }
    if (!amountAnonymous && (amount == null || isNaN(amount) || amount < 0)) { showToast('Enter a valid amount or check "Hide amount"', 'error'); return; }

    var btn = document.getElementById('investors-submit-btn');
    setButtonLoading(btn, true, 'Submittingâ€¦');
    var res = await sb.from('investors').insert({
      name: nameAnonymous ? null : (name || null),
      amount: amountAnonymous ? null : amount,
      name_is_anonymous: nameAnonymous,
      amount_is_anonymous: amountAnonymous,
      contact_email: email,
      contact_phone: phone
    }).select();
    setButtonLoading(btn, false, 'Submit');
    if (res.error) {
      showToast(res.error.message || 'Failed to add investment', 'error');
      return;
    }
    showToast('Thank you! Investment recorded.', 'success');
    document.getElementById('investor-name').value = '';
    document.getElementById('investor-amount').value = '';
    document.getElementById('investor-name-anonymous').checked = false;
    document.getElementById('investor-amount-anonymous').checked = false;
    document.getElementById('investor-email').value = '';
    document.getElementById('investor-phone').value = '';
    loadInvestors();
  });

  // ---- Emergency Contacts (localStorage) ----
  function loadEmergencyContacts() {
    var contacts = JSON.parse(localStorage.getItem('ridego_emergency_contacts') || '[]');
    var list = document.getElementById('emergency-contacts-list');
    if (!contacts.length) {
      list.innerHTML = '<p style="color: var(--text-muted); font-size: 14px; margin: 0;">No emergency contacts added yet.</p>';
      return;
    }
    list.innerHTML = contacts.map(function(c, i) {
      return '<div class="emergency-contact-item"><div><div style="font-weight:500;">' + escapeHtml(c.name) + '</div><div style="color:var(--text-muted);font-size:13px;">' + escapeHtml(c.phone) + '</div></div>' +
        '<button class="btn-text-danger" style="font-size:13px;padding:6px 10px;" data-idx="' + i + '">Remove</button></div>';
    }).join('');
  }

  // Add emergency contact
  document.getElementById('add-emergency-btn').addEventListener('click', function() {
    var nameEl = document.getElementById('emergency-name');
    var phoneEl = document.getElementById('emergency-phone');
    var name = nameEl.value.trim();
    var phone = phoneEl.value.trim();
    if (!name || !phone) { showToast('Please enter name and phone', 'error'); return; }
    var contacts = JSON.parse(localStorage.getItem('ridego_emergency_contacts') || '[]');
    if (contacts.length >= 3) { showToast('Maximum 3 emergency contacts', 'info'); return; }
    contacts.push({ name: name, phone: phone });
    localStorage.setItem('ridego_emergency_contacts', JSON.stringify(contacts));
    nameEl.value = '';
    phoneEl.value = '';
    loadEmergencyContacts();
    showToast('Emergency contact added', 'success');
  });

  // Remove emergency contact (delegated)
  document.getElementById('emergency-contacts-list').addEventListener('click', function(e) {
    var btn = e.target.closest('[data-idx]');
    if (!btn) return;
    var idx = parseInt(btn.getAttribute('data-idx'), 10);
    var contacts = JSON.parse(localStorage.getItem('ridego_emergency_contacts') || '[]');
    contacts.splice(idx, 1);
    localStorage.setItem('ridego_emergency_contacts', JSON.stringify(contacts));
    loadEmergencyContacts();
    showToast('Contact removed', 'info');
  });

  // Share trip from safety screen
  document.getElementById('share-trip-safety-btn').addEventListener('click', function() {
    showToast('Trip sharing is available during active rides', 'info');
  });

  // ---- Add Payment Method ----
  // Card brand selector (delegated)
  document.getElementById('card-brand-selector').addEventListener('click', function(e) {
    var btn = e.target.closest('.card-brand-btn');
    if (!btn) return;
    this.querySelectorAll('.card-brand-btn').forEach(function(b) { b.classList.remove('selected'); });
    btn.classList.add('selected');
  });

  // Save payment method
  document.getElementById('save-card-btn').addEventListener('click', async function() {
    var label = document.getElementById('new-card-label').value.trim();
    var last4 = document.getElementById('new-card-last4').value.trim();
    var brandBtn = document.querySelector('.card-brand-btn.selected');
    var brand = brandBtn ? brandBtn.getAttribute('data-brand') : 'visa';
    var isDefault = document.getElementById('new-card-default').checked;

    if (!label || !last4 || last4.length !== 4 || !/^\d{4}$/.test(last4)) {
      showToast('Please fill in all fields correctly', 'error');
      return;
    }

    var btn = this;
    setButtonLoading(btn, true, 'Saving...');

    var res = await sb.from('payment_methods').insert({
      user_id: currentUser.id,
      type: 'card',
      label: label,
      last_four: last4,
      brand: brand,
      is_default: isDefault
    });

    setButtonLoading(btn, false, 'Add Card');

    if (res.error) {
      showToast('Failed to add card: ' + res.error.message, 'error');
      return;
    }

    showToast('Payment method added!', 'success');
    document.getElementById('new-card-label').value = '';
    document.getElementById('new-card-last4').value = '';
    document.getElementById('new-card-default').checked = false;
    loadPaymentMethods();
    goBack('add-payment');
  });

  // Back from add-payment
  document.getElementById('add-payment-back').addEventListener('click', function() { goBack('add-payment'); });

  // Sign out
  document.getElementById('btn-signout').addEventListener('click', async function() {
    await sb.auth.signOut();
    currentUser = null;
    // Show auth screen, hide app
    document.getElementById('auth-screen').classList.remove('hidden');
    document.getElementById('app').style.display = 'none';
    // Reset to home screen
    screens[currentScreen].classList.remove('active');
    screens['home'].classList.add('active');
    currentScreen = 'home';
  });

  // Override showScreen to also update nav
  var _origShowScreen = showScreen;
  showScreen = function(name) {
    _origShowScreen(name);
    // Map screen names to nav names
    var navMap = { home: 'home', account: 'account', activity: 'activity', help: 'help' };
    updateNavActive(navMap[name] || '');
    // Initialize Google Maps for this screen
    initMapForScreen(name);
  };

  // ---- Event Listeners ----

  // Home â†’ Search
  $homeSearch.addEventListener('click', function() { showScreen('search'); });

  // Chips go to search
  document.querySelectorAll('.chip').forEach(function(chip) {
    chip.addEventListener('click', function() { showScreen('search'); });
  });

  // Search back
  $searchBack.addEventListener('click', function() { goBack('search'); });

  // Destination input filter
  $destInput.addEventListener('input', function() { filterSuggestions(this.value); });

  // Suggestion click (event delegation)
  document.getElementById('search-results').addEventListener('click', function(e) {
    var item = e.target.closest('.suggestion-item');
    if (!item) return;
    var name = item.getAttribute('data-name') || (item.querySelector('.place-name') ? item.querySelector('.place-name').textContent.trim() : '');
    var lat = parseFloat(item.getAttribute('data-lat'));
    var lng = parseFloat(item.getAttribute('data-lng'));
    var address = item.getAttribute('data-address') || '';
    if (name) selectDestination(name, address, lat, lng);
  });

  // Home recent places (delegated so dynamically loaded items work)
  document.querySelector('#screen-home .place-list').addEventListener('click', function(e) {
    var item = e.target.closest('.place-item');
    if (!item) return;
    var name = item.getAttribute('data-name') || (item.querySelector('.place-name') ? item.querySelector('.place-name').textContent.trim() : '');
    var lat = parseFloat(item.getAttribute('data-lat'));
    var lng = parseFloat(item.getAttribute('data-lng'));
    var address = item.getAttribute('data-address') || '';
    if (name) selectDestination(name, address, lat, lng);
  });

  // Seat controls
  $seatMinus.addEventListener('click', function() {
    if (requestedSeats > 1) { requestedSeats--; updateSeatSelector(); }
  });
  $seatPlus.addEventListener('click', function() {
    if (requestedSeats < 8) { requestedSeats++; updateSeatSelector(); }
  });

  // Ride option select (delegated)
  $rideOptions.addEventListener('click', function(e) {
    var option = e.target.closest('.ride-option');
    if (option && option.style.pointerEvents !== 'none') { haptic(); selectRide(option); }
  });

  // Ride back
  $rideBack.addEventListener('click', function() { goBack('ride-options'); });

  // Confirm ride â†’ matching
  $confirmBtn.addEventListener('click', function() { haptic(20); showScreen('matching'); });

  // Cancel matching
  $cancelMatching.addEventListener('click', function() {
    clearTimeout(matchingTimer);
    cancelRide();
    showScreen('home');
  });

  // Cancel trip
  $cancelTrip.addEventListener('click', function() {
    clearInterval(countdownTimer);
    cancelRide();
    showScreen('home');
  });

  // Complete trip
  $completeTripBtn.addEventListener('click', function() {
    clearInterval(countdownTimer);
    showScreen('complete');
  });

  // Stars
  $stars.addEventListener('click', function(e) {
    var btn = e.target.closest('.star-btn');
    if (!btn) return;
    haptic();
    var val = parseInt(btn.getAttribute('data-star'), 10);
    $stars.querySelectorAll('.star-btn').forEach(function(b) {
      b.classList.toggle('active', parseInt(b.getAttribute('data-star'), 10) <= val);
    });
  });

  // Tips
  $tipRow.addEventListener('click', function(e) {
    var btn = e.target.closest('.tip-btn');
    if (!btn) return;
    haptic();
    $tipRow.querySelectorAll('.tip-btn').forEach(function(b) { b.classList.remove('active'); });
    btn.classList.add('active');
  });

  // Done â†’ submit rating to DB, then go home
  $doneBtn.addEventListener('click', function() { submitRating(); });

  // Location permission modal
  document.getElementById('location-allow-btn').addEventListener('click', function() {
    localStorage.setItem('ridego_location_perm', 'granted');
    document.getElementById('location-modal').style.display = 'none';
    requestGeolocation();
  });

  document.getElementById('location-deny-btn').addEventListener('click', function() {
    localStorage.setItem('ridego_location_perm', 'denied');
    document.getElementById('location-modal').style.display = 'none';
    updateLocationStatus(false, 'Using default pickup');
    showToast('Using default pickup location', 'info');
  });

  // Active ride banner listeners
  document.getElementById('arb-resume').addEventListener('click', function() {
    resumeActiveRide();
  });

  document.getElementById('arb-cancel').addEventListener('click', function() {
    cancelActiveRide();
  });

  // Chat event listeners
  document.getElementById('trip-call-btn').addEventListener('click', function() {
    if (!matchedDriver) {
      showToast('Driver info not available yet', 'info');
      return;
    }
    sb.from('drivers')
      .select('phone')
      .eq('id', matchedDriver.driver_id)
      .single()
      .then(function(res) {
        if (res.error || !res.data || !res.data.phone) {
          showToast('Could not get driver phone number', 'error');
          return;
        }
        window.open('tel:' + res.data.phone);
      });
  });

  document.getElementById('trip-message-btn').addEventListener('click', function() {
    openChat();
  });

  document.getElementById('chat-close-btn').addEventListener('click', function() {
    closeChat();
  });

  document.getElementById('chat-send-btn').addEventListener('click', function() {
    sendChatMessage();
  });

  document.getElementById('chat-input').addEventListener('input', function() {
    document.getElementById('chat-send-btn').disabled = !this.value.trim();
  });

  document.getElementById('chat-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      if (this.value.trim()) sendChatMessage();
    }
  });

  // ---- Google Maps Integration ----
  var GOOGLE_MAPS_KEY = window.__RIDEGO_GOOGLE_MAPS_KEY || '';
  var _gmapsReady = false;
  var _gmapInstances = {};
  var _gmapMarkers = {};
  var _gmapPolylines = {};

  var DARK_MAP_STYLE = [
    { elementType: 'geometry', stylers: [{ color: '#0D0F14' }] },
    { elementType: 'labels.text.fill', stylers: [{ color: '#6B7280' }] },
    { elementType: 'labels.text.stroke', stylers: [{ color: '#0D0F14' }] },
    { featureType: 'administrative', elementType: 'geometry.stroke', stylers: [{ color: '#2E3340' }] },
    { featureType: 'administrative.land_parcel', elementType: 'labels', stylers: [{ visibility: 'off' }] },
    { featureType: 'poi', stylers: [{ visibility: 'off' }] },
    { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#1A1D26' }] },
    { featureType: 'road', elementType: 'geometry.stroke', stylers: [{ color: '#2E3340' }] },
    { featureType: 'road.highway', elementType: 'geometry', stylers: [{ color: '#242834' }] },
    { featureType: 'road.highway', elementType: 'geometry.stroke', stylers: [{ color: '#2E3340' }] },
    { featureType: 'transit', elementType: 'geometry', stylers: [{ color: '#1A1D26' }] },
    { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#0a1628' }] },
    { featureType: 'water', elementType: 'labels.text.fill', stylers: [{ color: '#4a5568' }] }
  ];

  window.initGoogleMaps = function() {
    console.log('[Maps] Google Maps API loaded successfully');
    _gmapsReady = true;
    initMapForScreen(currentScreen);
  };

  window.gm_authFailure = function() {
    console.error('[Maps] Google Maps authentication failed â€” check API key and billing');
  };

  function initMapForScreen(screenName) {
    if (!_gmapsReady) return;
    console.log('[Maps] Initializing map for screen:', screenName);
    switch (screenName) {
      case 'home': initHomeMap(); break;
      case 'ride-options': initRideMap(); break;
      case 'matching': initMatchingMap(); break;
      case 'trip': initTripMap(); break;
    }
  }

  function _createMap(containerId, center, zoom) {
    var el = document.getElementById(containerId);
    if (!el) return null;
    return new google.maps.Map(el, {
      center: center,
      zoom: zoom || 15,
      disableDefaultUI: true,
      zoomControl: false,
      mapTypeControl: false,
      streetViewControl: false,
      fullscreenControl: false,
      styles: DARK_MAP_STYLE,
      gestureHandling: 'greedy',
      backgroundColor: '#0D0F14'
    });
  }

  function _circleIcon(color) {
    return {
      path: google.maps.SymbolPath.CIRCLE,
      scale: 8,
      fillColor: color,
      fillOpacity: 1,
      strokeColor: '#ffffff',
      strokeWeight: 3
    };
  }

  function initHomeMap() {
    var pos = { lat: PICKUP.lat, lng: PICKUP.lng };
    if (_gmapInstances.home) {
      _gmapInstances.home.setCenter(pos);
      if (_gmapMarkers.homeLoc) _gmapMarkers.homeLoc.setPosition(pos);
      console.log('[Maps] Home map updated, center:', pos);
      return;
    }
    var el = document.getElementById('gmap-home');
    console.log('[Maps] gmap-home element:', el, 'dimensions:', el ? el.offsetWidth + 'x' + el.offsetHeight : 'N/A');
    var map = _createMap('gmap-home', pos, 15);
    if (!map) { console.error('[Maps] Failed to create home map'); return; }
    _gmapInstances.home = map;
    _gmapMarkers.homeLoc = new google.maps.Marker({ position: pos, map: map, icon: _circleIcon('#3B82F6'), title: 'Your location' });
    console.log('[Maps] Home map created successfully');
  }

  function initMatchingMap() {
    var pos = { lat: PICKUP.lat, lng: PICKUP.lng };
    if (_gmapInstances.matching) {
      _gmapInstances.matching.setCenter(pos);
      if (_gmapMarkers.matchLoc) _gmapMarkers.matchLoc.setPosition(pos);
      return;
    }
    var map = _createMap('gmap-matching', pos, 15);
    if (!map) return;
    _gmapInstances.matching = map;
    _gmapMarkers.matchLoc = new google.maps.Marker({ position: pos, map: map, icon: _circleIcon('#3B82F6'), title: 'Your location' });
  }

  function _fitBounds(map, p1, p2, bottomPad) {
    var bounds = new google.maps.LatLngBounds();
    bounds.extend(p1);
    bounds.extend(p2);
    map.fitBounds(bounds, { top: 80, bottom: bottomPad || 300, left: 40, right: 40 });
  }

  function _drawPolyline(key, map, pickup, dest) {
    if (_gmapPolylines[key]) _gmapPolylines[key].setMap(null);
    if (cachedRoute && cachedRoute.polyline && google.maps.geometry) {
      try {
        var path = google.maps.geometry.encoding.decodePath(cachedRoute.polyline);
        _gmapPolylines[key] = new google.maps.Polyline({ path: path, geodesic: true, strokeColor: '#3B82F6', strokeOpacity: 0.8, strokeWeight: 4, map: map });
        return;
      } catch (e) { console.warn('Polyline decode failed:', e); }
    }
    _gmapPolylines[key] = new google.maps.Polyline({ path: [pickup, dest], geodesic: true, strokeColor: '#3B82F6', strokeOpacity: 0.5, strokeWeight: 3, map: map });
  }

  function initRideMap() {
    if (!selectedDestination) return;
    var pickup = { lat: PICKUP.lat, lng: PICKUP.lng };
    var dest = { lat: selectedDestination.lat, lng: selectedDestination.lng };
    if (!_gmapInstances.ride) {
      var map = _createMap('gmap-ride', pickup, 13);
      if (!map) return;
      _gmapInstances.ride = map;
      _gmapMarkers.ridePickup = new google.maps.Marker({ position: pickup, map: map, icon: _circleIcon('#00D26A'), title: PICKUP.name });
      _gmapMarkers.rideDest = new google.maps.Marker({ position: dest, map: map, icon: _circleIcon('#FF4757'), title: selectedDestination.name });
    } else {
      _gmapMarkers.ridePickup.setPosition(pickup);
      _gmapMarkers.rideDest.setPosition(dest);
      _gmapMarkers.rideDest.setTitle(selectedDestination.name);
    }
    _fitBounds(_gmapInstances.ride, pickup, dest);
    _drawPolyline('ride', _gmapInstances.ride, pickup, dest);
  }

  function initTripMap() {
    if (!selectedDestination) return;
    var pickup = { lat: PICKUP.lat, lng: PICKUP.lng };
    var dest = { lat: selectedDestination.lat, lng: selectedDestination.lng };
    if (!_gmapInstances.trip) {
      var map = _createMap('gmap-trip', pickup, 13);
      if (!map) return;
      _gmapInstances.trip = map;
      _gmapMarkers.tripPickup = new google.maps.Marker({ position: pickup, map: map, icon: _circleIcon('#00D26A'), title: PICKUP.name });
      _gmapMarkers.tripDest = new google.maps.Marker({ position: dest, map: map, icon: _circleIcon('#FF4757'), title: selectedDestination.name });
    } else {
      _gmapMarkers.tripPickup.setPosition(pickup);
      _gmapMarkers.tripDest.setPosition(dest);
      _gmapMarkers.tripDest.setTitle(selectedDestination.name);
    }
    _fitBounds(_gmapInstances.trip, pickup, dest);
    _drawPolyline('trip', _gmapInstances.trip, pickup, dest);
  }

  function updateGmapLocation(lat, lng) {
    var pos = { lat: lat, lng: lng };
    if (_gmapInstances.home) {
      _gmapInstances.home.setCenter(pos);
      if (_gmapMarkers.homeLoc) _gmapMarkers.homeLoc.setPosition(pos);
    }
    if (_gmapInstances.matching) {
      _gmapInstances.matching.setCenter(pos);
      if (_gmapMarkers.matchLoc) _gmapMarkers.matchLoc.setPosition(pos);
    }
  }

  // Load Google Maps API dynamically
  if (GOOGLE_MAPS_KEY) {
    console.log('[Maps] Loading Google Maps API...');
    var _gms = document.createElement('script');
    _gms.src = 'https://maps.googleapis.com/maps/api/js?key=' + GOOGLE_MAPS_KEY + '&callback=initGoogleMaps&libraries=geometry&v=weekly';
    _gms.async = true;
    _gms.onerror = function() { console.error('[Maps] Failed to load Google Maps script'); };
    document.head.appendChild(_gms);
  } else {
    console.warn('[Maps] No GOOGLE_MAPS_KEY found in config.js');
  }

  // ---- App Init ----
  async function initApp() {
    updateGreeting();
    updateStatusTime();
    setInterval(updateStatusTime, 10000);
    checkLocationPermission();

    // User is already authenticated via the auth screen
    if (!currentUser) {
      var sessionResult = await sb.auth.getSession();
      if (sessionResult.data.session) {
        currentUser = sessionResult.data.session.user;
      } else {
        console.error('No authenticated user');
        return;
      }
    }
    console.log('Signed in as:', currentUser.email, currentUser.id);

    // Load ride types from DB
    var rtResult = await sb.from('ride_types')
      .select('*')
      .eq('is_active', true)
      .order('sort_order');

    if (!rtResult.error && rtResult.data) {
      rideTypes = rtResult.data;
      console.log('Loaded', rideTypes.length, 'ride types from DB');
    } else {
      console.error('Failed to load ride types:', rtResult.error);
      showToast('Failed to load ride types', 'error');
    }

    // Load recent searches for home + search screens
    loadRecentSearches();

    // Check for active rides from previous session
    checkActiveRide();

    // Initialize Google Maps for home screen
    initMapForScreen('home');
  }

  // initApp() is called by the auth flow (checkSession or handleSignIn/handleSignUp)
})();
</script>
</body>
</html>
